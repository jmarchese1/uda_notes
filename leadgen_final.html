<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.40">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Automated Lead Generation Pipeline</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="leadgen_final_files/libs/clipboard/clipboard.min.js"></script>
<script src="leadgen_final_files/libs/quarto-html/quarto.js"></script>
<script src="leadgen_final_files/libs/quarto-html/popper.min.js"></script>
<script src="leadgen_final_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="leadgen_final_files/libs/quarto-html/anchor.min.js"></script>
<link href="leadgen_final_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="leadgen_final_files/libs/quarto-html/quarto-syntax-highlighting-549806ee2085284f45b00abea8c6df48.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="leadgen_final_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="leadgen_final_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="leadgen_final_files/libs/bootstrap/bootstrap-8a79a254b8e706d3c925cde0a310d4f0.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Automated Lead Generation Pipeline</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>introduction: In this project I will be scraping clutch.co for digital marketing agencies and then checking their websites for chatbots and contact details. The data will be cleaned and merged with SEMrush data to provide a comprehensive overview of the leads. After that the data is passed through a scoring model based on all of the collected variables and it decides if a lead is hot or cold (0-100 score). The final data will be saved to a Google Cloud BigQuery table where the data will be refreshed on a weekly scheduler and also saved to a CSV file. The goal is serve as a middle man connecting chatbot providers with potential clients. Industry standards sell hot leads for up to $300 so im hoping this project can be the start of a lucrative business opportunity.</p>
<div id="7cdfe1c3" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> asyncio</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> random</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> playwright.async_api <span class="im">import</span> async_playwright</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> playwright_stealth <span class="im">import</span> stealth_async</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> requests</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> urllib.parse</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> re</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> urllib.parse <span class="im">import</span> urlparse, urlencode</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> urllib3</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> math</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="co">"""</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="co">      _       _       _                  _                _                                   _             </span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="co">     | |     | |     | |                | |              | |                                 | |            </span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="co">  ___| |_   _| |_ ___| |__    ___ ___   | | ___  __ _  __| |   __ _  ___ _ __   ___ _ __ __ _| |_ ___  _ __ </span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="co"> / __| | | | | __/ __| '_ \  / __/ _ \  | |/ _ \/ _` |/ _` |  / _` |/ _ \ '_ \ / _ \ '__/ _` | __/ _ \| '__|</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="co">| (__| | |_| | || (__| | | || (_| (_) | | |  __/ (_| | (_| | | (_| |  __/ | | |  __/ | | (_| | || (_) | |   </span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="co"> \___|_|\__,_|\__\___|_| |_(_)___\___/  |_|\___|\__,_|\__,_|  \__, |\___|_| |_|\___|_|  \__,_|\__\___/|_|   </span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a><span class="co">                                                               __/ |                                        </span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a><span class="co">                                                              |___/                                         </span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a><span class="co">"""</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>&lt;&gt;:16: SyntaxWarning:

invalid escape sequence '\ '

&lt;&gt;:16: SyntaxWarning:

invalid escape sequence '\ '

C:\Users\jason\AppData\Local\Temp\ipykernel_112892\3170408507.py:16: SyntaxWarning:

invalid escape sequence '\ '
</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>"\n      _       _       _                  _                _                                   _             \n     | |     | |     | |                | |              | |                                 | |            \n  ___| |_   _| |_ ___| |__    ___ ___   | | ___  __ _  __| |   __ _  ___ _ __   ___ _ __ __ _| |_ ___  _ __ \n / __| | | | | __/ __| '_ \\  / __/ _ \\  | |/ _ \\/ _` |/ _` |  / _` |/ _ \\ '_ \\ / _ \\ '__/ _` | __/ _ \\| '__|\n| (__| | |_| | || (__| | | || (_| (_) | | |  __/ (_| | (_| | | (_| |  __/ | | |  __/ | | (_| | || (_) | |   \n \\___|_|\\__,_|\\__\\___|_| |_(_)___\\___/  |_|\\___|\\__,_|\\__,_|  \\__, |\\___|_| |_|\\___|_|  \\__,_|\\__\\___/|_|   \n                                                               __/ |                                        \n                                                              |___/                                         \n"</code></pre>
</div>
</div>
<p>Here I am intializing my helper functions to be used later for cleaning the data and extracting the domain from the URLs. I also have a function to simulate human behavior on the website to avoid being blocked by clutch.co. The simulate_human_behavior function scrolls through the page, moves the mouse randomly, and occasionally presses safe keys to mimic user interactions. I kept getting blocked with captchas when I was scraping the website so I had to add this function to avoid that.</p>
<div id="48f4c842" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">#===================================#</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="co">#          HELPER FUNCTIONS</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="co">#===================================#</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> clean_domain(url):</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Extract the domain (without scheme) from a URL."""</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    pattern_extract <span class="op">=</span> re.<span class="bu">compile</span>(<span class="vs">r"^(https?://[^/?]+)"</span>, re.IGNORECASE)</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    pattern_scheme <span class="op">=</span> re.<span class="bu">compile</span>(<span class="vs">r"^https?://"</span>, re.IGNORECASE)</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    match <span class="op">=</span> pattern_extract.match(url)</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> match:</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>        base <span class="op">=</span> match.group(<span class="dv">1</span>)</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> pattern_scheme.sub(<span class="st">""</span>, base)</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> url</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> extract_and_clean_url(clutch_redirect_url):</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract the real website URL from the "u=" parameter if present</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>    parsed_url <span class="op">=</span> urllib.parse.parse_qs(urllib.parse.urlparse(clutch_redirect_url).query)</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">"u"</span> <span class="kw">in</span> parsed_url:</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>        real_url <span class="op">=</span> urllib.parse.unquote(parsed_url[<span class="st">"u"</span>][<span class="dv">0</span>])  <span class="co"># Decode URL-encoded string</span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>        real_url <span class="op">=</span> clutch_redirect_url  <span class="co"># If no "u=" param, use original URL</span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Remove everything after "?" to strip tracking parameters</span></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>    clean_url <span class="op">=</span> urllib.parse.urljoin(real_url, urllib.parse.urlparse(real_url).path)</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> clean_url</span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a><span class="cf">async</span> <span class="kw">def</span> simulate_human_behavior(page):</span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Simulates realistic user interactions without clicking on navigation links."""</span></span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Scroll through the page multiple times with different speeds</span></span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(random.randint(<span class="dv">3</span>, <span class="dv">6</span>)):</span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">await</span> page.mouse.wheel(<span class="dv">0</span>, random.randint(<span class="dv">200</span>, <span class="dv">500</span>))</span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>        <span class="cf">await</span> asyncio.sleep(random.uniform(<span class="dv">1</span>, <span class="dv">3</span>))</span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Move mouse randomly to simulate looking around</span></span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> random.randint(<span class="dv">100</span>, <span class="dv">1200</span>)</span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a>        y <span class="op">=</span> random.randint(<span class="dv">100</span>, <span class="dv">800</span>)</span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a>        <span class="cf">await</span> page.mouse.move(x, y, steps<span class="op">=</span>random.randint(<span class="dv">5</span>, <span class="dv">15</span>))</span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Pause to mimic reading behavior</span></span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a>        <span class="cf">await</span> asyncio.sleep(random.uniform(<span class="dv">2</span>, <span class="dv">4</span>))</span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Occasionally press safe keys (scrolling keys only)</span></span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> random.random() <span class="op">&gt;</span> <span class="fl">0.5</span>:</span>
<span id="cb4-48"><a href="#cb4-48" aria-hidden="true" tabindex="-1"></a>            <span class="cf">await</span> page.keyboard.press(random.choice([<span class="st">"ArrowDown"</span>, <span class="st">"ArrowUp"</span>, <span class="st">"PageDown"</span>, <span class="st">"PageUp"</span>]))</span>
<span id="cb4-49"><a href="#cb4-49" aria-hidden="true" tabindex="-1"></a>            <span class="cf">await</span> asyncio.sleep(random.uniform(<span class="dv">1</span>, <span class="dv">2</span>))</span>
<span id="cb4-50"><a href="#cb4-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-51"><a href="#cb4-51" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Randomly hover over **non-interactive** elements to avoid clicking links</span></span>
<span id="cb4-52"><a href="#cb4-52" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> random.random() <span class="op">&gt;</span> <span class="fl">0.7</span>:</span>
<span id="cb4-53"><a href="#cb4-53" aria-hidden="true" tabindex="-1"></a>        elements <span class="op">=</span> <span class="cf">await</span> page.query_selector_all(<span class="st">"div, p, span"</span>)</span>
<span id="cb4-54"><a href="#cb4-54" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> elements:</span>
<span id="cb4-55"><a href="#cb4-55" aria-hidden="true" tabindex="-1"></a>            random_element <span class="op">=</span> random.choice(elements)</span>
<span id="cb4-56"><a href="#cb4-56" aria-hidden="true" tabindex="-1"></a>            <span class="cf">await</span> random_element.hover()</span>
<span id="cb4-57"><a href="#cb4-57" aria-hidden="true" tabindex="-1"></a>            <span class="cf">await</span> asyncio.sleep(random.uniform(<span class="dv">1</span>, <span class="dv">3</span>))</span>
<span id="cb4-58"><a href="#cb4-58" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-59"><a href="#cb4-59" aria-hidden="true" tabindex="-1"></a><span class="co">#-------------------#</span></span>
<span id="cb4-60"><a href="#cb4-60" aria-hidden="true" tabindex="-1"></a><span class="co">#clean final df</span></span>
<span id="cb4-61"><a href="#cb4-61" aria-hidden="true" tabindex="-1"></a><span class="co">#-------------------#</span></span>
<span id="cb4-62"><a href="#cb4-62" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> math</span>
<span id="cb4-63"><a href="#cb4-63" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb4-64"><a href="#cb4-64" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> re</span>
<span id="cb4-65"><a href="#cb4-65" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> math</span>
<span id="cb4-66"><a href="#cb4-66" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb4-67"><a href="#cb4-67" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> re</span>
<span id="cb4-68"><a href="#cb4-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-69"><a href="#cb4-69" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> clean_final_clutch_df(df_final):</span>
<span id="cb4-70"><a href="#cb4-70" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Clean and extract numeric values for 'Size'</span></span>
<span id="cb4-71"><a href="#cb4-71" aria-hidden="true" tabindex="-1"></a>    df_final[<span class="st">"Size"</span>] <span class="op">=</span> df_final[<span class="st">"Size"</span>].<span class="bu">apply</span>(</span>
<span id="cb4-72"><a href="#cb4-72" aria-hidden="true" tabindex="-1"></a>        <span class="kw">lambda</span> x: np.mean([<span class="bu">int</span>(num.replace(<span class="st">","</span>, <span class="st">""</span>)) <span class="cf">for</span> num <span class="kw">in</span> re.findall(<span class="vs">r"[\d,]+"</span>, x)])</span>
<span id="cb4-73"><a href="#cb4-73" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> re.findall(<span class="vs">r"[\d,]+"</span>, x) <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb4-74"><a href="#cb4-74" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb4-75"><a href="#cb4-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-76"><a href="#cb4-76" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Clean 'Reviews' (Projects) column</span></span>
<span id="cb4-77"><a href="#cb4-77" aria-hidden="true" tabindex="-1"></a>    df_final[<span class="st">"Projects"</span>] <span class="op">=</span> df_final[<span class="st">"Reviews"</span>].<span class="bu">apply</span>(</span>
<span id="cb4-78"><a href="#cb4-78" aria-hidden="true" tabindex="-1"></a>        <span class="kw">lambda</span> x: <span class="bu">int</span>(re.search(<span class="vs">r"\d+"</span>, x).group()) <span class="cf">if</span> re.search(<span class="vs">r"\d+"</span>, x) <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb4-79"><a href="#cb4-79" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb4-80"><a href="#cb4-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-81"><a href="#cb4-81" aria-hidden="true" tabindex="-1"></a>    df_final[<span class="st">"Price"</span>] <span class="op">=</span> df_final[<span class="st">"Price"</span>].<span class="bu">apply</span>(</span>
<span id="cb4-82"><a href="#cb4-82" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> x: <span class="bu">int</span>(re.sub(<span class="vs">r"[^\d]"</span>, <span class="st">""</span>, x)) <span class="cf">if</span> <span class="bu">isinstance</span>(x, <span class="bu">str</span>) <span class="kw">and</span> re.search(<span class="vs">r"\d+"</span>, x) <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb4-83"><a href="#cb4-83" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb4-84"><a href="#cb4-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-85"><a href="#cb4-85" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Strip whitespace from 'Business_Name' and 'Location'</span></span>
<span id="cb4-86"><a href="#cb4-86" aria-hidden="true" tabindex="-1"></a>    df_final[<span class="st">"Business_Name"</span>] <span class="op">=</span> df_final[<span class="st">"Business_Name"</span>].<span class="bu">str</span>.strip()</span>
<span id="cb4-87"><a href="#cb4-87" aria-hidden="true" tabindex="-1"></a>    df_final[<span class="st">"Location"</span>] <span class="op">=</span> df_final[<span class="st">"Location"</span>].<span class="bu">str</span>.strip()</span>
<span id="cb4-88"><a href="#cb4-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-89"><a href="#cb4-89" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Ensure numeric types and fill missing values</span></span>
<span id="cb4-90"><a href="#cb4-90" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> col <span class="kw">in</span> [<span class="st">'Projects'</span>,<span class="st">'Size'</span>,<span class="st">'Price'</span>]:</span>
<span id="cb4-91"><a href="#cb4-91" aria-hidden="true" tabindex="-1"></a>        df_final[col] <span class="op">=</span> pd.to_numeric(df_final[col].fillna(<span class="dv">0</span>))</span>
<span id="cb4-92"><a href="#cb4-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-93"><a href="#cb4-93" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Drop redundant columns</span></span>
<span id="cb4-94"><a href="#cb4-94" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> col <span class="kw">in</span> [<span class="st">"URL"</span>, <span class="st">"Reviews"</span>, <span class="st">"Contact Page Found, Chatbot Provider"</span>]:</span>
<span id="cb4-95"><a href="#cb4-95" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> col <span class="kw">in</span> df_final.columns:</span>
<span id="cb4-96"><a href="#cb4-96" aria-hidden="true" tabindex="-1"></a>            df_final.drop(col, axis<span class="op">=</span><span class="dv">1</span>, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb4-97"><a href="#cb4-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-98"><a href="#cb4-98" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Reorder columns for better readability</span></span>
<span id="cb4-99"><a href="#cb4-99" aria-hidden="true" tabindex="-1"></a>    desired_order <span class="op">=</span> [</span>
<span id="cb4-100"><a href="#cb4-100" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Business_Name"</span>, <span class="st">"Industry"</span>, <span class="st">"lead_score"</span>, <span class="st">"original_website"</span>, </span>
<span id="cb4-101"><a href="#cb4-101" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Has Chatbot"</span>, <span class="st">"Visits"</span>, <span class="st">"Unique Visitors"</span>, <span class="st">"Pages/Visit"</span>,</span>
<span id="cb4-102"><a href="#cb4-102" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Bounce Rate"</span>, <span class="st">"Visit Duration"</span>, <span class="st">"Price"</span>, <span class="st">"Projects"</span>, <span class="st">"Size"</span>,  </span>
<span id="cb4-103"><a href="#cb4-103" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Emails"</span>, <span class="st">"Phone"</span>, <span class="st">"Instagram"</span>, <span class="st">"LinkedIn"</span>, <span class="st">"Facebook"</span>, <span class="st">"Twitter"</span>, </span>
<span id="cb4-104"><a href="#cb4-104" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Company Description"</span>, <span class="st">"Location"</span>, <span class="st">"cleaned_website"</span></span>
<span id="cb4-105"><a href="#cb4-105" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb4-106"><a href="#cb4-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-107"><a href="#cb4-107" aria-hidden="true" tabindex="-1"></a>    df_final <span class="op">=</span> df_final[[col <span class="cf">for</span> col <span class="kw">in</span> desired_order <span class="cf">if</span> col <span class="kw">in</span> df_final.columns]]</span>
<span id="cb4-108"><a href="#cb4-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-109"><a href="#cb4-109" aria-hidden="true" tabindex="-1"></a>    df_final <span class="op">=</span> df_final.loc[df_final[<span class="st">"Has Chatbot"</span>] <span class="op">!=</span> <span class="st">"Yes"</span>]</span>
<span id="cb4-110"><a href="#cb4-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-111"><a href="#cb4-111" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df_final</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Below is my scoring function for rating the quality of the leads. The scoring is based on various metrics such as website traffic, bounce rate, visit duration, and social media presence. The function calculates a score between 0 and 100 for each lead based on these metrics. The higher the score, the more promising the lead is considered to be. This is about the template I used for the scoring function. After alot of testing I was able to make the mean lead score be ~50 meaning leads higher than that are on the warmer side and leads lower than that are on the colder side.</p>
<div id="0a3b6a64" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ----------------- #</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="co">#   SCORING FUNCTION</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="co"># ----------------- #</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> add_lead_score(df):</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> safe_get_numeric(row, key):</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>        val <span class="op">=</span> row.get(key, <span class="dv">0</span>)</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> pd.isna(val):</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="fl">0.0</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="bu">float</span>(val)</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="fl">0.0</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> calc_score(row):</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>        has_chatbot <span class="op">=</span> <span class="bu">str</span>(row.get(<span class="st">'Has Chatbot'</span>) <span class="kw">or</span> <span class="st">""</span>).strip().lower()</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> has_chatbot <span class="op">==</span> <span class="st">"yes"</span>:</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="dv">0</span>  <span class="co"># Ignore companies already using chatbots</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>        score <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Total Visits (max 25): More visits = greater potential</span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>        visits <span class="op">=</span> safe_get_numeric(row, <span class="st">'Visits'</span>)</span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>        visits_score <span class="op">=</span> <span class="bu">min</span>(<span class="dv">25</span>, (visits <span class="op">/</span> <span class="dv">5000</span>) <span class="op">*</span> <span class="dv">25</span>)</span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>        score <span class="op">+=</span> visits_score</span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Bounce Rate (max 20): High bounce rate = greater need</span></span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>        bounce_rate <span class="op">=</span> safe_get_numeric(row, <span class="st">'Bounce Rate'</span>)</span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>        bounce_score <span class="op">=</span> <span class="bu">min</span>(<span class="dv">20</span>, (bounce_rate <span class="op">/</span> <span class="dv">100</span>) <span class="op">*</span> <span class="dv">20</span>)</span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>        score <span class="op">+=</span> bounce_score</span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Visit Duration (max 20): Shorter duration = higher opportunity</span></span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>        visit_duration <span class="op">=</span> safe_get_numeric(row, <span class="st">'Visit Duration'</span>)</span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> visit_duration <span class="op">&lt;</span> <span class="dv">60</span>:  <span class="co"># under 1 min</span></span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>            duration_score <span class="op">=</span> <span class="dv">20</span></span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> visit_duration <span class="op">&lt;</span> <span class="dv">120</span>:  <span class="co"># 1-2 mins</span></span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>            duration_score <span class="op">=</span> <span class="dv">15</span></span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> visit_duration <span class="op">&lt;</span> <span class="dv">180</span>:  <span class="co"># 2-3 mins</span></span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a>            duration_score <span class="op">=</span> <span class="dv">10</span></span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> visit_duration <span class="op">&lt;</span> <span class="dv">240</span>:  <span class="co"># 3-4 mins</span></span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a>            duration_score <span class="op">=</span> <span class="dv">5</span></span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:  <span class="co"># over 4 mins, fantastic engagement</span></span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a>            duration_score <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a>        score <span class="op">+=</span> duration_score</span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Pages per Visit (max 10): fewer pages = higher opportunity</span></span>
<span id="cb5-46"><a href="#cb5-46" aria-hidden="true" tabindex="-1"></a>        pages_per_visit <span class="op">=</span> safe_get_numeric(row, <span class="st">'Pages/Visit'</span>)</span>
<span id="cb5-47"><a href="#cb5-47" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> pages_per_visit <span class="op">&lt;</span> <span class="dv">2</span>:</span>
<span id="cb5-48"><a href="#cb5-48" aria-hidden="true" tabindex="-1"></a>            pages_score <span class="op">=</span> <span class="dv">10</span></span>
<span id="cb5-49"><a href="#cb5-49" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> pages_per_visit <span class="op">&lt;</span> <span class="dv">4</span>:</span>
<span id="cb5-50"><a href="#cb5-50" aria-hidden="true" tabindex="-1"></a>            pages_score <span class="op">=</span> <span class="dv">5</span></span>
<span id="cb5-51"><a href="#cb5-51" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb5-52"><a href="#cb5-52" aria-hidden="true" tabindex="-1"></a>            pages_score <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb5-53"><a href="#cb5-53" aria-hidden="true" tabindex="-1"></a>        score <span class="op">+=</span> pages_score</span>
<span id="cb5-54"><a href="#cb5-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-55"><a href="#cb5-55" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Projects Acquired (max 10): Indicates affordability</span></span>
<span id="cb5-56"><a href="#cb5-56" aria-hidden="true" tabindex="-1"></a>        projects <span class="op">=</span> safe_get_numeric(row, <span class="st">'Projects'</span>)</span>
<span id="cb5-57"><a href="#cb5-57" aria-hidden="true" tabindex="-1"></a>        projects_score <span class="op">=</span> <span class="bu">min</span>(<span class="dv">10</span>, (projects <span class="op">/</span> <span class="dv">8</span>) <span class="op">*</span> <span class="dv">10</span>)</span>
<span id="cb5-58"><a href="#cb5-58" aria-hidden="true" tabindex="-1"></a>        score <span class="op">+=</span> projects_score</span>
<span id="cb5-59"><a href="#cb5-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-60"><a href="#cb5-60" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Contactability (max 10): Email (5) + Phone (5)</span></span>
<span id="cb5-61"><a href="#cb5-61" aria-hidden="true" tabindex="-1"></a>        email <span class="op">=</span> row.get(<span class="st">'Emails'</span>)</span>
<span id="cb5-62"><a href="#cb5-62" aria-hidden="true" tabindex="-1"></a>        email_score <span class="op">=</span> <span class="fl">2.5</span> <span class="cf">if</span> email <span class="kw">and</span> <span class="st">"@"</span> <span class="kw">in</span> <span class="bu">str</span>(email) <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb5-63"><a href="#cb5-63" aria-hidden="true" tabindex="-1"></a>        phone <span class="op">=</span> <span class="bu">str</span>(row.get(<span class="st">'Phone'</span>) <span class="kw">or</span> <span class="st">""</span>).strip().lower()</span>
<span id="cb5-64"><a href="#cb5-64" aria-hidden="true" tabindex="-1"></a>        phone_score <span class="op">=</span> <span class="fl">2.5</span> <span class="cf">if</span> phone <span class="kw">and</span> phone <span class="op">!=</span> <span class="st">"n/a"</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb5-65"><a href="#cb5-65" aria-hidden="true" tabindex="-1"></a>        score <span class="op">+=</span> email_score <span class="op">+</span> phone_score</span>
<span id="cb5-66"><a href="#cb5-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-67"><a href="#cb5-67" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Social Media Presence (max 5)</span></span>
<span id="cb5-68"><a href="#cb5-68" aria-hidden="true" tabindex="-1"></a>        social_media_count <span class="op">=</span> <span class="bu">sum</span>(<span class="dv">1</span> <span class="cf">for</span> col <span class="kw">in</span> [<span class="st">'Instagram'</span>, <span class="st">'LinkedIn'</span>, <span class="st">'Facebook'</span>, <span class="st">'Twitter'</span>] <span class="cf">if</span> <span class="bu">str</span>(row.get(col) <span class="kw">or</span> <span class="st">""</span>).strip())</span>
<span id="cb5-69"><a href="#cb5-69" aria-hidden="true" tabindex="-1"></a>        social_media_score <span class="op">=</span> (social_media_count <span class="op">/</span> <span class="dv">4</span>) <span class="op">*</span> <span class="dv">10</span></span>
<span id="cb5-70"><a href="#cb5-70" aria-hidden="true" tabindex="-1"></a>        score <span class="op">+=</span> social_media_score</span>
<span id="cb5-71"><a href="#cb5-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-72"><a href="#cb5-72" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">round</span>(<span class="bu">min</span>(score, <span class="dv">100</span>), <span class="dv">2</span>)</span>
<span id="cb5-73"><a href="#cb5-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-74"><a href="#cb5-74" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-75"><a href="#cb5-75" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'lead_score'</span>] <span class="op">=</span> df.<span class="bu">apply</span>(calc_score, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb5-76"><a href="#cb5-76" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here is the primary function in my scraper. Extracting the business name, profile URL, website, industry, reviews, size, location, and price from the clutch.co listing pages. I also added a function to scrape the profile pages for the website link if it was not found on the listing page. The data is then cleaned and returned as a DataFrame. I set a semaphore to handle concurency and maximize what my computer is capable of. I also set up a two pass system where if the website link is not on the main business card I will go to the profile page and scrape it from there. This was espcially frustrating because after scraping 200 pages (20000) businesses I realized after page 20 most of the links were in the profiles.</p>
<div id="7d6ab58a" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co">#------------------------------------------------</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="co">#              CLUTCH.CO SCRAPER</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="co">#------------------------------------------------</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="cf">async</span> <span class="kw">def</span> pass_a_scrape_clutch_listings(base_url, max_pages<span class="op">=</span><span class="dv">5</span>):</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="co">    Pass A: Scrape main listing pages (1..max_pages).</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns a DataFrame with columns:</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="co">      - Business_Name, Profile_URL, Website (possibly N/A),</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="co">      - Industry, Reviews, Size, Location, Price, etc.</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> []</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> page_number <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">201</span>, max_pages <span class="op">+</span> <span class="dv">1</span>):</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>        page_url <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>base_url<span class="sc">}</span><span class="ss">?page=</span><span class="sc">{</span>page_number<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"🔎 [Pass A] Scraping Listing Page: </span><span class="sc">{</span>page_url<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">async</span> <span class="cf">with</span> async_playwright() <span class="im">as</span> p:</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>            browser <span class="op">=</span> <span class="cf">await</span> p.chromium.launch(headless<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>            context <span class="op">=</span> <span class="cf">await</span> browser.new_context(</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>                user_agent<span class="op">=</span>(</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>                    <span class="ss">f"Mozilla/5.0 (Windows NT 10.0; Win64; x64) "</span></span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>                    <span class="ss">f"AppleWebKit/537.36 (KHTML, like Gecko) "</span></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>                    <span class="ss">f"Chrome/</span><span class="sc">{</span>random<span class="sc">.</span>randint(<span class="dv">95</span>, <span class="dv">119</span>)<span class="sc">}</span><span class="ss">.0.0.0 Safari/537.36"</span></span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>                ),</span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>                viewport<span class="op">=</span>{<span class="st">"width"</span>: random.randint(<span class="dv">1200</span>, <span class="dv">1600</span>), <span class="st">"height"</span>: random.randint(<span class="dv">800</span>, <span class="dv">1000</span>)},</span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>            <span class="cf">await</span> stealth_async(context)</span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>            page <span class="op">=</span> <span class="cf">await</span> context.new_page()</span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span>:</span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a>                <span class="cf">await</span> page.goto(page_url, timeout<span class="op">=</span><span class="dv">60000</span>)</span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a>                <span class="cf">await</span> asyncio.sleep(random.uniform(<span class="dv">5</span>, <span class="dv">12</span>))</span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a>                <span class="cf">try</span>:</span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">await</span> page.wait_for_selector(<span class="st">".provider-row"</span>, timeout<span class="op">=</span><span class="dv">20000</span>)</span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">await</span> simulate_human_behavior(page)</span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a>                <span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a>                    <span class="bu">print</span>(<span class="ss">f"⚠️ Blocked or no data on listing page </span><span class="sc">{</span>page_number<span class="sc">}</span><span class="ss">. Trying next page..."</span>)</span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">await</span> browser.close()</span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">continue</span></span>
<span id="cb6-42"><a href="#cb6-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-43"><a href="#cb6-43" aria-hidden="true" tabindex="-1"></a>                businesses <span class="op">=</span> <span class="cf">await</span> page.query_selector_all(<span class="st">".provider-row"</span>)</span>
<span id="cb6-44"><a href="#cb6-44" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f"   ✅ Found </span><span class="sc">{</span><span class="bu">len</span>(businesses)<span class="sc">}</span><span class="ss"> agencies on page </span><span class="sc">{</span>page_number<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb6-45"><a href="#cb6-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-46"><a href="#cb6-46" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> biz <span class="kw">in</span> businesses:</span>
<span id="cb6-47"><a href="#cb6-47" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">try</span>:</span>
<span id="cb6-48"><a href="#cb6-48" aria-hidden="true" tabindex="-1"></a>                        name_element <span class="op">=</span> <span class="cf">await</span> biz.query_selector(<span class="st">".provider__title-link"</span>)</span>
<span id="cb6-49"><a href="#cb6-49" aria-hidden="true" tabindex="-1"></a>                        name <span class="op">=</span> <span class="cf">await</span> name_element.inner_text() <span class="cf">if</span> name_element <span class="cf">else</span> <span class="st">"N/A"</span></span>
<span id="cb6-50"><a href="#cb6-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-51"><a href="#cb6-51" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># Profile link</span></span>
<span id="cb6-52"><a href="#cb6-52" aria-hidden="true" tabindex="-1"></a>                        profile_element <span class="op">=</span> <span class="cf">await</span> biz.query_selector(<span class="st">".provider__title-link.directory_profile"</span>)</span>
<span id="cb6-53"><a href="#cb6-53" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> profile_element:</span>
<span id="cb6-54"><a href="#cb6-54" aria-hidden="true" tabindex="-1"></a>                            profile_url <span class="op">=</span> <span class="cf">await</span> profile_element.get_attribute(<span class="st">"href"</span>)</span>
<span id="cb6-55"><a href="#cb6-55" aria-hidden="true" tabindex="-1"></a>                            <span class="cf">if</span> profile_url <span class="kw">and</span> <span class="kw">not</span> profile_url.startswith(<span class="st">"http"</span>):</span>
<span id="cb6-56"><a href="#cb6-56" aria-hidden="true" tabindex="-1"></a>                                profile_url <span class="op">=</span> <span class="st">"https://clutch.co"</span> <span class="op">+</span> profile_url</span>
<span id="cb6-57"><a href="#cb6-57" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">else</span>:</span>
<span id="cb6-58"><a href="#cb6-58" aria-hidden="true" tabindex="-1"></a>                            profile_url <span class="op">=</span> <span class="va">None</span></span>
<span id="cb6-59"><a href="#cb6-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-60"><a href="#cb6-60" aria-hidden="true" tabindex="-1"></a>                        reviews_element <span class="op">=</span> <span class="cf">await</span> biz.query_selector(<span class="st">".sg-rating__reviews"</span>)</span>
<span id="cb6-61"><a href="#cb6-61" aria-hidden="true" tabindex="-1"></a>                        reviews <span class="op">=</span> <span class="cf">await</span> reviews_element.inner_text() <span class="cf">if</span> reviews_element <span class="cf">else</span> <span class="st">"N/A"</span></span>
<span id="cb6-62"><a href="#cb6-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-63"><a href="#cb6-63" aria-hidden="true" tabindex="-1"></a>                        price_element <span class="op">=</span> <span class="cf">await</span> biz.query_selector(<span class="st">".min-project-size"</span>)</span>
<span id="cb6-64"><a href="#cb6-64" aria-hidden="true" tabindex="-1"></a>                        price <span class="op">=</span> <span class="cf">await</span> price_element.inner_text() <span class="cf">if</span> price_element <span class="cf">else</span> <span class="st">"N/A"</span></span>
<span id="cb6-65"><a href="#cb6-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-66"><a href="#cb6-66" aria-hidden="true" tabindex="-1"></a>                        employees_element <span class="op">=</span> <span class="cf">await</span> biz.query_selector(<span class="st">".employees-count"</span>)</span>
<span id="cb6-67"><a href="#cb6-67" aria-hidden="true" tabindex="-1"></a>                        employees <span class="op">=</span> <span class="cf">await</span> employees_element.inner_text() <span class="cf">if</span> employees_element <span class="cf">else</span> <span class="st">"N/A"</span></span>
<span id="cb6-68"><a href="#cb6-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-69"><a href="#cb6-69" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># Potential industries</span></span>
<span id="cb6-70"><a href="#cb6-70" aria-hidden="true" tabindex="-1"></a>                        industry_elements <span class="op">=</span> <span class="cf">await</span> biz.query_selector_all(</span>
<span id="cb6-71"><a href="#cb6-71" aria-hidden="true" tabindex="-1"></a>                            <span class="st">".provider__services-list .provider__services-list-item"</span></span>
<span id="cb6-72"><a href="#cb6-72" aria-hidden="true" tabindex="-1"></a>                        )</span>
<span id="cb6-73"><a href="#cb6-73" aria-hidden="true" tabindex="-1"></a>                        industry <span class="op">=</span> <span class="st">"N/A"</span></span>
<span id="cb6-74"><a href="#cb6-74" aria-hidden="true" tabindex="-1"></a>                        max_percent <span class="op">=</span> <span class="op">-</span><span class="dv">1</span></span>
<span id="cb6-75"><a href="#cb6-75" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> industry_elements:</span>
<span id="cb6-76"><a href="#cb6-76" aria-hidden="true" tabindex="-1"></a>                            <span class="cf">for</span> element <span class="kw">in</span> industry_elements:</span>
<span id="cb6-77"><a href="#cb6-77" aria-hidden="true" tabindex="-1"></a>                                text <span class="op">=</span> <span class="cf">await</span> element.inner_text()</span>
<span id="cb6-78"><a href="#cb6-78" aria-hidden="true" tabindex="-1"></a>                                match <span class="op">=</span> re.match(<span class="vs">r"(\d+)%\s*(.*)"</span>, text)</span>
<span id="cb6-79"><a href="#cb6-79" aria-hidden="true" tabindex="-1"></a>                                <span class="cf">if</span> match:</span>
<span id="cb6-80"><a href="#cb6-80" aria-hidden="true" tabindex="-1"></a>                                    percent <span class="op">=</span> <span class="bu">int</span>(match.group(<span class="dv">1</span>))</span>
<span id="cb6-81"><a href="#cb6-81" aria-hidden="true" tabindex="-1"></a>                                    <span class="cf">if</span> percent <span class="op">&gt;</span> max_percent:</span>
<span id="cb6-82"><a href="#cb6-82" aria-hidden="true" tabindex="-1"></a>                                        max_percent <span class="op">=</span> percent</span>
<span id="cb6-83"><a href="#cb6-83" aria-hidden="true" tabindex="-1"></a>                                        industry <span class="op">=</span> match.group(<span class="dv">2</span>).strip()</span>
<span id="cb6-84"><a href="#cb6-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-85"><a href="#cb6-85" aria-hidden="true" tabindex="-1"></a>                        location_element <span class="op">=</span> <span class="cf">await</span> biz.query_selector(<span class="st">".location"</span>)</span>
<span id="cb6-86"><a href="#cb6-86" aria-hidden="true" tabindex="-1"></a>                        location <span class="op">=</span> <span class="cf">await</span> location_element.inner_text() <span class="cf">if</span> location_element <span class="cf">else</span> <span class="st">"N/A"</span></span>
<span id="cb6-87"><a href="#cb6-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-88"><a href="#cb6-88" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># Check if there's a .website-link__item on the listing card</span></span>
<span id="cb6-89"><a href="#cb6-89" aria-hidden="true" tabindex="-1"></a>                        website_element <span class="op">=</span> <span class="cf">await</span> biz.query_selector(<span class="st">".website-link__item"</span>)</span>
<span id="cb6-90"><a href="#cb6-90" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> website_element:</span>
<span id="cb6-91"><a href="#cb6-91" aria-hidden="true" tabindex="-1"></a>                            website <span class="op">=</span> <span class="cf">await</span> website_element.get_attribute(<span class="st">"href"</span>)</span>
<span id="cb6-92"><a href="#cb6-92" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">else</span>:</span>
<span id="cb6-93"><a href="#cb6-93" aria-hidden="true" tabindex="-1"></a>                            website <span class="op">=</span> <span class="st">"N/A"</span></span>
<span id="cb6-94"><a href="#cb6-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-95"><a href="#cb6-95" aria-hidden="true" tabindex="-1"></a>                        results.append({</span>
<span id="cb6-96"><a href="#cb6-96" aria-hidden="true" tabindex="-1"></a>                            <span class="st">"Business_Name"</span>: name.strip() <span class="cf">if</span> name <span class="cf">else</span> <span class="st">"N/A"</span>,</span>
<span id="cb6-97"><a href="#cb6-97" aria-hidden="true" tabindex="-1"></a>                            <span class="st">"Profile_URL"</span>: profile_url,</span>
<span id="cb6-98"><a href="#cb6-98" aria-hidden="true" tabindex="-1"></a>                            <span class="st">"Website"</span>: website,</span>
<span id="cb6-99"><a href="#cb6-99" aria-hidden="true" tabindex="-1"></a>                            <span class="st">"Industry"</span>: industry,</span>
<span id="cb6-100"><a href="#cb6-100" aria-hidden="true" tabindex="-1"></a>                            <span class="st">"Reviews"</span>: reviews,</span>
<span id="cb6-101"><a href="#cb6-101" aria-hidden="true" tabindex="-1"></a>                            <span class="st">"Size"</span>: employees,</span>
<span id="cb6-102"><a href="#cb6-102" aria-hidden="true" tabindex="-1"></a>                            <span class="st">"Location"</span>: location,</span>
<span id="cb6-103"><a href="#cb6-103" aria-hidden="true" tabindex="-1"></a>                            <span class="st">"Price"</span>: price,</span>
<span id="cb6-104"><a href="#cb6-104" aria-hidden="true" tabindex="-1"></a>                        })</span>
<span id="cb6-105"><a href="#cb6-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-106"><a href="#cb6-106" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb6-107"><a href="#cb6-107" aria-hidden="true" tabindex="-1"></a>                        <span class="bu">print</span>(<span class="ss">f"   ⚠️ Skipping agency due to error: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb6-108"><a href="#cb6-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-109"><a href="#cb6-109" aria-hidden="true" tabindex="-1"></a>            <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb6-110"><a href="#cb6-110" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f"⚠️ Failed to load </span><span class="sc">{</span>page_url<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb6-111"><a href="#cb6-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-112"><a href="#cb6-112" aria-hidden="true" tabindex="-1"></a>            <span class="cf">await</span> browser.close()</span>
<span id="cb6-113"><a href="#cb6-113" aria-hidden="true" tabindex="-1"></a>            <span class="cf">await</span> asyncio.sleep(random.uniform(<span class="dv">15</span>, <span class="dv">25</span>))</span>
<span id="cb6-114"><a href="#cb6-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-115"><a href="#cb6-115" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> pd.DataFrame(results)</span>
<span id="cb6-116"><a href="#cb6-116" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"✅ [Pass A] Collected </span><span class="sc">{</span><span class="bu">len</span>(df)<span class="sc">}</span><span class="ss"> listings across </span><span class="sc">{</span>max_pages<span class="sc">}</span><span class="ss"> pages."</span>)</span>
<span id="cb6-117"><a href="#cb6-117" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb6-118"><a href="#cb6-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-119"><a href="#cb6-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-120"><a href="#cb6-120" aria-hidden="true" tabindex="-1"></a><span class="co"># ===============================</span></span>
<span id="cb6-121"><a href="#cb6-121" aria-hidden="true" tabindex="-1"></a><span class="co">#  PASS B: PROFILE PAGES</span></span>
<span id="cb6-122"><a href="#cb6-122" aria-hidden="true" tabindex="-1"></a><span class="co"># ===============================</span></span>
<span id="cb6-123"><a href="#cb6-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-124"><a href="#cb6-124" aria-hidden="true" tabindex="-1"></a><span class="cf">async</span> <span class="kw">def</span> pass_b_scrape_clutch_profile(profile_url):</span>
<span id="cb6-125"><a href="#cb6-125" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb6-126"><a href="#cb6-126" aria-hidden="true" tabindex="-1"></a><span class="co">    For a single profile URL, open a fresh browser context to get .website-link__item</span></span>
<span id="cb6-127"><a href="#cb6-127" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns the website or "N/A" if not found.</span></span>
<span id="cb6-128"><a href="#cb6-128" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb6-129"><a href="#cb6-129" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> profile_url:</span>
<span id="cb6-130"><a href="#cb6-130" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">"N/A"</span></span>
<span id="cb6-131"><a href="#cb6-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-132"><a href="#cb6-132" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="cf">with</span> async_playwright() <span class="im">as</span> p:</span>
<span id="cb6-133"><a href="#cb6-133" aria-hidden="true" tabindex="-1"></a>        browser <span class="op">=</span> <span class="cf">await</span> p.chromium.launch(headless<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb6-134"><a href="#cb6-134" aria-hidden="true" tabindex="-1"></a>        context <span class="op">=</span> <span class="cf">await</span> browser.new_context(</span>
<span id="cb6-135"><a href="#cb6-135" aria-hidden="true" tabindex="-1"></a>            user_agent<span class="op">=</span>(</span>
<span id="cb6-136"><a href="#cb6-136" aria-hidden="true" tabindex="-1"></a>                <span class="ss">f"Mozilla/5.0 (Windows NT 10.0; Win64; x64) "</span></span>
<span id="cb6-137"><a href="#cb6-137" aria-hidden="true" tabindex="-1"></a>                <span class="ss">f"AppleWebKit/537.36 (KHTML, like Gecko) "</span></span>
<span id="cb6-138"><a href="#cb6-138" aria-hidden="true" tabindex="-1"></a>                <span class="ss">f"Chrome/</span><span class="sc">{</span>random<span class="sc">.</span>randint(<span class="dv">95</span>, <span class="dv">119</span>)<span class="sc">}</span><span class="ss">.0.0.0 Safari/537.36"</span></span>
<span id="cb6-139"><a href="#cb6-139" aria-hidden="true" tabindex="-1"></a>            ),</span>
<span id="cb6-140"><a href="#cb6-140" aria-hidden="true" tabindex="-1"></a>            viewport<span class="op">=</span>{<span class="st">"width"</span>: <span class="dv">1280</span>, <span class="st">"height"</span>: <span class="dv">800</span>}</span>
<span id="cb6-141"><a href="#cb6-141" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb6-142"><a href="#cb6-142" aria-hidden="true" tabindex="-1"></a>        <span class="cf">await</span> stealth_async(context)</span>
<span id="cb6-143"><a href="#cb6-143" aria-hidden="true" tabindex="-1"></a>        page <span class="op">=</span> <span class="cf">await</span> context.new_page()</span>
<span id="cb6-144"><a href="#cb6-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-145"><a href="#cb6-145" aria-hidden="true" tabindex="-1"></a>        website <span class="op">=</span> <span class="st">"N/A"</span></span>
<span id="cb6-146"><a href="#cb6-146" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb6-147"><a href="#cb6-147" aria-hidden="true" tabindex="-1"></a>            <span class="cf">await</span> page.goto(profile_url, timeout<span class="op">=</span><span class="dv">60000</span>)</span>
<span id="cb6-148"><a href="#cb6-148" aria-hidden="true" tabindex="-1"></a>            <span class="cf">await</span> asyncio.sleep(random.uniform(<span class="dv">3</span>, <span class="dv">7</span>))</span>
<span id="cb6-149"><a href="#cb6-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-150"><a href="#cb6-150" aria-hidden="true" tabindex="-1"></a>            <span class="co"># We could optionally simulate_human_behavior(page) here as well</span></span>
<span id="cb6-151"><a href="#cb6-151" aria-hidden="true" tabindex="-1"></a>            <span class="cf">await</span> page.wait_for_selector(<span class="st">".website-link__item"</span>, timeout<span class="op">=</span><span class="dv">20000</span>)</span>
<span id="cb6-152"><a href="#cb6-152" aria-hidden="true" tabindex="-1"></a>            site_el <span class="op">=</span> <span class="cf">await</span> page.query_selector(<span class="st">".website-link__item"</span>)</span>
<span id="cb6-153"><a href="#cb6-153" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> site_el:</span>
<span id="cb6-154"><a href="#cb6-154" aria-hidden="true" tabindex="-1"></a>                website <span class="op">=</span> <span class="cf">await</span> site_el.get_attribute(<span class="st">"href"</span>)</span>
<span id="cb6-155"><a href="#cb6-155" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb6-156"><a href="#cb6-156" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"   ⚠️ Could not load profile or find website link: </span><span class="sc">{</span>profile_url<span class="sc">}</span><span class="ss"> =&gt; </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb6-157"><a href="#cb6-157" aria-hidden="true" tabindex="-1"></a>        <span class="cf">finally</span>:</span>
<span id="cb6-158"><a href="#cb6-158" aria-hidden="true" tabindex="-1"></a>            <span class="cf">await</span> browser.close()</span>
<span id="cb6-159"><a href="#cb6-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-160"><a href="#cb6-160" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> website</span>
<span id="cb6-161"><a href="#cb6-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-162"><a href="#cb6-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-163"><a href="#cb6-163" aria-hidden="true" tabindex="-1"></a><span class="cf">async</span> <span class="kw">def</span> pass_b_scrape_missing_websites(df, concurrency<span class="op">=</span><span class="dv">3</span>):</span>
<span id="cb6-164"><a href="#cb6-164" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb6-165"><a href="#cb6-165" aria-hidden="true" tabindex="-1"></a><span class="co">    For each row in df with Website == "N/A" and a valid Profile_URL,</span></span>
<span id="cb6-166"><a href="#cb6-166" aria-hidden="true" tabindex="-1"></a><span class="co">    open the profile in concurrency, fetch the real site.</span></span>
<span id="cb6-167"><a href="#cb6-167" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns updated DataFrame with website filled in.</span></span>
<span id="cb6-168"><a href="#cb6-168" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb6-169"><a href="#cb6-169" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.copy()</span>
<span id="cb6-170"><a href="#cb6-170" aria-hidden="true" tabindex="-1"></a>    mask <span class="op">=</span> (df[<span class="st">"Website"</span>] <span class="op">==</span> <span class="st">"N/A"</span>) <span class="op">&amp;</span> (df[<span class="st">"Profile_URL"</span>].notna())</span>
<span id="cb6-171"><a href="#cb6-171" aria-hidden="true" tabindex="-1"></a>    rows_to_fix <span class="op">=</span> df[mask]</span>
<span id="cb6-172"><a href="#cb6-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-173"><a href="#cb6-173" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> rows_to_fix.empty:</span>
<span id="cb6-174"><a href="#cb6-174" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"[Pass B] No missing websites to fix."</span>)</span>
<span id="cb6-175"><a href="#cb6-175" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> df</span>
<span id="cb6-176"><a href="#cb6-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-177"><a href="#cb6-177" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"[Pass B] Need to scrape </span><span class="sc">{</span><span class="bu">len</span>(rows_to_fix)<span class="sc">}</span><span class="ss"> profile pages for missing websites..."</span>)</span>
<span id="cb6-178"><a href="#cb6-178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-179"><a href="#cb6-179" aria-hidden="true" tabindex="-1"></a>    semaphore <span class="op">=</span> asyncio.Semaphore(concurrency)</span>
<span id="cb6-180"><a href="#cb6-180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-181"><a href="#cb6-181" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> worker(idx, profile_url):</span>
<span id="cb6-182"><a href="#cb6-182" aria-hidden="true" tabindex="-1"></a>        <span class="cf">async</span> <span class="cf">with</span> semaphore:</span>
<span id="cb6-183"><a href="#cb6-183" aria-hidden="true" tabindex="-1"></a>            site <span class="op">=</span> <span class="cf">await</span> pass_b_scrape_clutch_profile(profile_url)</span>
<span id="cb6-184"><a href="#cb6-184" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> idx, site</span>
<span id="cb6-185"><a href="#cb6-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-186"><a href="#cb6-186" aria-hidden="true" tabindex="-1"></a>    tasks <span class="op">=</span> []</span>
<span id="cb6-187"><a href="#cb6-187" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> idx, row <span class="kw">in</span> rows_to_fix.iterrows():</span>
<span id="cb6-188"><a href="#cb6-188" aria-hidden="true" tabindex="-1"></a>        tasks.append(worker(idx, row[<span class="st">"Profile_URL"</span>]))</span>
<span id="cb6-189"><a href="#cb6-189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-190"><a href="#cb6-190" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> <span class="cf">await</span> asyncio.gather(<span class="op">*</span>[asyncio.create_task(t) <span class="cf">for</span> t <span class="kw">in</span> tasks])</span>
<span id="cb6-191"><a href="#cb6-191" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (idx, site) <span class="kw">in</span> results:</span>
<span id="cb6-192"><a href="#cb6-192" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> site:</span>
<span id="cb6-193"><a href="#cb6-193" aria-hidden="true" tabindex="-1"></a>            df.at[idx, <span class="st">"Website"</span>] <span class="op">=</span> site</span>
<span id="cb6-194"><a href="#cb6-194" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb6-195"><a href="#cb6-195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-196"><a href="#cb6-196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-197"><a href="#cb6-197" aria-hidden="true" tabindex="-1"></a><span class="co"># ===============================</span></span>
<span id="cb6-198"><a href="#cb6-198" aria-hidden="true" tabindex="-1"></a><span class="co">#  TWO-PASS PIPELINE</span></span>
<span id="cb6-199"><a href="#cb6-199" aria-hidden="true" tabindex="-1"></a><span class="co"># ===============================</span></span>
<span id="cb6-200"><a href="#cb6-200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-201"><a href="#cb6-201" aria-hidden="true" tabindex="-1"></a><span class="cf">async</span> <span class="kw">def</span> two_pass_clutch_pipeline(base_url, max_pages<span class="op">=</span><span class="dv">5</span>):</span>
<span id="cb6-202"><a href="#cb6-202" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb6-203"><a href="#cb6-203" aria-hidden="true" tabindex="-1"></a><span class="co">    1) Pass A: Gather listings (Name, Price, Profile_URL, etc.)</span></span>
<span id="cb6-204"><a href="#cb6-204" aria-hidden="true" tabindex="-1"></a><span class="co">    2) Pass B: For rows with Website == 'N/A', open Profile_URL to get .website-link__item</span></span>
<span id="cb6-205"><a href="#cb6-205" aria-hidden="true" tabindex="-1"></a><span class="co">       (done concurrently)</span></span>
<span id="cb6-206"><a href="#cb6-206" aria-hidden="true" tabindex="-1"></a><span class="co">    3) Clean any Clutch redirect URLs in final DataFrame, remove placeholders</span></span>
<span id="cb6-207"><a href="#cb6-207" aria-hidden="true" tabindex="-1"></a><span class="co">    4) Return final DataFrame</span></span>
<span id="cb6-208"><a href="#cb6-208" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb6-209"><a href="#cb6-209" aria-hidden="true" tabindex="-1"></a>    start_time <span class="op">=</span> time.time()</span>
<span id="cb6-210"><a href="#cb6-210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-211"><a href="#cb6-211" aria-hidden="true" tabindex="-1"></a>    <span class="co"># -- PASS A --</span></span>
<span id="cb6-212"><a href="#cb6-212" aria-hidden="true" tabindex="-1"></a>    df_listings <span class="op">=</span> <span class="cf">await</span> pass_a_scrape_clutch_listings(base_url, max_pages)</span>
<span id="cb6-213"><a href="#cb6-213" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> df_listings.empty:</span>
<span id="cb6-214"><a href="#cb6-214" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"🚫 No listings found at all. Returning empty DataFrame."</span>)</span>
<span id="cb6-215"><a href="#cb6-215" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> df_listings</span>
<span id="cb6-216"><a href="#cb6-216" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-217"><a href="#cb6-217" aria-hidden="true" tabindex="-1"></a>    <span class="co"># -- PASS B --</span></span>
<span id="cb6-218"><a href="#cb6-218" aria-hidden="true" tabindex="-1"></a>    df_listings <span class="op">=</span> <span class="cf">await</span> pass_b_scrape_missing_websites(df_listings, concurrency<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb6-219"><a href="#cb6-219" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-220"><a href="#cb6-220" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Clean redirect-style URLs</span></span>
<span id="cb6-221"><a href="#cb6-221" aria-hidden="true" tabindex="-1"></a>    df_listings[<span class="st">"Website"</span>] <span class="op">=</span> df_listings[<span class="st">"Website"</span>].<span class="bu">apply</span>(extract_and_clean_url)</span>
<span id="cb6-222"><a href="#cb6-222" aria-hidden="true" tabindex="-1"></a>    df_listings <span class="op">=</span> df_listings[df_listings[<span class="st">"Website"</span>] <span class="op">!=</span> <span class="st">"https://ppc.clutch.co/ppc/click/"</span>]</span>
<span id="cb6-223"><a href="#cb6-223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-224"><a href="#cb6-224" aria-hidden="true" tabindex="-1"></a>    end_time <span class="op">=</span> time.time()</span>
<span id="cb6-225"><a href="#cb6-225" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"✅ two_pass_clutch_pipeline completed in </span><span class="sc">{</span>end_time <span class="op">-</span> start_time<span class="sc">:.2f}</span><span class="ss"> sec. Total rows: </span><span class="sc">{</span><span class="bu">len</span>(df_listings)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb6-226"><a href="#cb6-226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-227"><a href="#cb6-227" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df_listings</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>After gathering the urls and data from clutch.co I then check each website for the presence of a chatbot and other contact information. I use a list of common chatbot selectors and script providers to identify if a chatbot is present on the page. The function also extracts contact information such as email addresses, phone numbers, and social media links. The results are returned in a structured format for further analysis. I also added a semaphore to limit the number of concurrent requests to avoid overwhelming the target websites.</p>
<div id="adaa8fff" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="co"># PART B: CHATBOT DETECTION</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="co">#using the cleaned websites from clutch (not the redirect links) to go to each website seperately </span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="co">#and extract useful information</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="cf">async</span> <span class="kw">def</span> check_single_website(url):</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a><span class="co">    Checks a single website for chatbot/contact info.</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns a dictionary with structured results.</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Chatbot detection selectors</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>    chatbot_selectors <span class="op">=</span> [</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>        <span class="st">'iframe'</span>, <span class="st">'[id*="chat"]'</span>, <span class="st">'[class*="chat"]'</span>,</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>        <span class="st">'.chat-button'</span>, <span class="st">'.chat-widget'</span>, <span class="st">'.chat-icon'</span>,</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>        <span class="st">'button[aria-label*="chat"]'</span>, <span class="st">'button[aria-label*="support"]'</span>,</span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>        <span class="st">'div[data-testid*="chat"]'</span>, <span class="st">'div[class*="live-chat"]'</span>, <span class="st">'div[class*="helpdesk"]'</span>,</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>        <span class="st">'.tawk-chat'</span>, <span class="st">'.intercom-messenger-frame'</span>, <span class="st">'.zopim'</span>, <span class="st">'.zendesk-chat'</span>,</span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>        <span class="st">'.crisp-client'</span>, <span class="st">'[src*="chatlio.com"]'</span>, <span class="st">'[src*="freshchat.com"]'</span>,</span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>        <span class="st">'iframe[src*="drift.com"]'</span>, <span class="st">'iframe[src*="tawk.to"]'</span>, <span class="st">'iframe[src*="tidio.co"]'</span>,</span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>        <span class="st">'iframe[src*="livechatinc.com"]'</span>, <span class="st">'iframe[src*="smartsupp.com"]'</span>,</span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>        <span class="st">'iframe[src*="olark.com"]'</span>, <span class="st">'iframe[src*="snapengage.com"]'</span>,</span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>        <span class="st">'iframe[src*="helpcrunch.com"]'</span>,</span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>        <span class="st">'script[src*="drift.com"]'</span>, <span class="st">'script[src*="tawk.to"]'</span>, <span class="st">'script[src*="tidio.co"]'</span>,</span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>        <span class="st">'script[src*="livechatinc.com"]'</span>, <span class="st">'script[src*="smartsupp.com"]'</span>,</span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>        <span class="st">'script[src*="olark.com"]'</span>, <span class="st">'script[src*="snapengage.com"]'</span>,</span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>        <span class="st">'script[src*="helpcrunch.com"]'</span></span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Chatbot providers</span></span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a>    chatbot_script_providers <span class="op">=</span> {</span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a>        <span class="st">'intercom.com'</span>: <span class="st">'Intercom'</span>,</span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a>        <span class="st">'tawk.to'</span>: <span class="st">'Tawk.to'</span>,</span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a>        <span class="st">'drift.com'</span>: <span class="st">'Drift'</span>,</span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a>        <span class="st">'zopim.com'</span>: <span class="st">'Zopim'</span>,</span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a>        <span class="st">'crisp.chat'</span>: <span class="st">'Crisp'</span>,</span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a>        <span class="st">'freshchat.com'</span>: <span class="st">'Freshchat'</span>,</span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true" tabindex="-1"></a>        <span class="st">'zendesk.com'</span>: <span class="st">'Zendesk'</span>,</span>
<span id="cb7-41"><a href="#cb7-41" aria-hidden="true" tabindex="-1"></a>        <span class="st">'chatlio.com'</span>: <span class="st">'Chatlio'</span>,</span>
<span id="cb7-42"><a href="#cb7-42" aria-hidden="true" tabindex="-1"></a>        <span class="st">'smartsupp.com'</span>: <span class="st">'SmartSupp'</span>,</span>
<span id="cb7-43"><a href="#cb7-43" aria-hidden="true" tabindex="-1"></a>        <span class="st">'livechatinc.com'</span>: <span class="st">'LiveChat'</span>,</span>
<span id="cb7-44"><a href="#cb7-44" aria-hidden="true" tabindex="-1"></a>        <span class="st">'tidio.co'</span>: <span class="st">'Tidio'</span>,</span>
<span id="cb7-45"><a href="#cb7-45" aria-hidden="true" tabindex="-1"></a>        <span class="st">'olark.com'</span>: <span class="st">'Olark'</span>,</span>
<span id="cb7-46"><a href="#cb7-46" aria-hidden="true" tabindex="-1"></a>        <span class="st">'snapengage.com'</span>: <span class="st">'SnapEngage'</span>,</span>
<span id="cb7-47"><a href="#cb7-47" aria-hidden="true" tabindex="-1"></a>        <span class="st">'helpcrunch.com'</span>: <span class="st">'HelpCrunch'</span>,</span>
<span id="cb7-48"><a href="#cb7-48" aria-hidden="true" tabindex="-1"></a>        <span class="st">'comm100.com'</span>: <span class="st">'Comm100'</span>,</span>
<span id="cb7-49"><a href="#cb7-49" aria-hidden="true" tabindex="-1"></a>        <span class="st">'boldchat.com'</span>: <span class="st">'BoldChat'</span></span>
<span id="cb7-50"><a href="#cb7-50" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb7-51"><a href="#cb7-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-52"><a href="#cb7-52" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Search for contact pages and email domains</span></span>
<span id="cb7-53"><a href="#cb7-53" aria-hidden="true" tabindex="-1"></a>    contact_keywords <span class="op">=</span> [<span class="st">"contact"</span>, <span class="st">"support"</span>, <span class="st">"help"</span>, <span class="st">"about"</span>]</span>
<span id="cb7-54"><a href="#cb7-54" aria-hidden="true" tabindex="-1"></a>    valid_email_domains <span class="op">=</span> {<span class="st">".com"</span>, <span class="st">".org"</span>, <span class="st">".net"</span>, <span class="st">".edu"</span>, <span class="st">".gov"</span>, <span class="st">".co"</span>, <span class="st">".io"</span>, <span class="st">".biz"</span>, <span class="st">".info"</span>}</span>
<span id="cb7-55"><a href="#cb7-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-56"><a href="#cb7-56" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Initializing the metrics</span></span>
<span id="cb7-57"><a href="#cb7-57" aria-hidden="true" tabindex="-1"></a>    chatbot_found <span class="op">=</span> <span class="va">False</span></span>
<span id="cb7-58"><a href="#cb7-58" aria-hidden="true" tabindex="-1"></a>    chatbot_provider <span class="op">=</span> <span class="va">None</span></span>
<span id="cb7-59"><a href="#cb7-59" aria-hidden="true" tabindex="-1"></a>    company_description <span class="op">=</span> <span class="va">None</span></span>
<span id="cb7-60"><a href="#cb7-60" aria-hidden="true" tabindex="-1"></a>    contact_page_found <span class="op">=</span> <span class="st">"No"</span></span>
<span id="cb7-61"><a href="#cb7-61" aria-hidden="true" tabindex="-1"></a>    emails <span class="op">=</span> <span class="bu">set</span>()</span>
<span id="cb7-62"><a href="#cb7-62" aria-hidden="true" tabindex="-1"></a>    phone <span class="op">=</span> <span class="st">"N/A"</span></span>
<span id="cb7-63"><a href="#cb7-63" aria-hidden="true" tabindex="-1"></a>    instagram, linkedin, facebook, twitter <span class="op">=</span> <span class="va">None</span>, <span class="va">None</span>, <span class="va">None</span>, <span class="va">None</span></span>
<span id="cb7-64"><a href="#cb7-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-65"><a href="#cb7-65" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="cf">with</span> async_playwright() <span class="im">as</span> p:</span>
<span id="cb7-66"><a href="#cb7-66" aria-hidden="true" tabindex="-1"></a>        browser <span class="op">=</span> <span class="cf">await</span> p.chromium.launch(headless<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb7-67"><a href="#cb7-67" aria-hidden="true" tabindex="-1"></a>        context <span class="op">=</span> <span class="cf">await</span> browser.new_context()</span>
<span id="cb7-68"><a href="#cb7-68" aria-hidden="true" tabindex="-1"></a>        page <span class="op">=</span> <span class="cf">await</span> context.new_page()</span>
<span id="cb7-69"><a href="#cb7-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-70"><a href="#cb7-70" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb7-71"><a href="#cb7-71" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Ensure the URL starts with http or https</span></span>
<span id="cb7-72"><a href="#cb7-72" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">not</span> url.startswith(<span class="st">"http"</span>):</span>
<span id="cb7-73"><a href="#cb7-73" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f"⚠️ Skipping invalid URL: </span><span class="sc">{</span>url<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb7-74"><a href="#cb7-74" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> {<span class="st">"Website"</span>: url, <span class="st">"Has Chatbot"</span>: <span class="st">"Invalid URL"</span>}</span>
<span id="cb7-75"><a href="#cb7-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-76"><a href="#cb7-76" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"🔍 Checking </span><span class="sc">{</span>url<span class="sc">}</span><span class="ss"> for chatbot/contact info..."</span>)</span>
<span id="cb7-77"><a href="#cb7-77" aria-hidden="true" tabindex="-1"></a>            <span class="cf">await</span> page.goto(url, timeout<span class="op">=</span><span class="dv">12000</span>)</span>
<span id="cb7-78"><a href="#cb7-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-79"><a href="#cb7-79" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Check for chatbot selectors</span></span>
<span id="cb7-80"><a href="#cb7-80" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> selector <span class="kw">in</span> chatbot_selectors:</span>
<span id="cb7-81"><a href="#cb7-81" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="cf">await</span> page.query_selector(selector):</span>
<span id="cb7-82"><a href="#cb7-82" aria-hidden="true" tabindex="-1"></a>                    chatbot_found <span class="op">=</span> <span class="va">True</span></span>
<span id="cb7-83"><a href="#cb7-83" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">break</span></span>
<span id="cb7-84"><a href="#cb7-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-85"><a href="#cb7-85" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Check for chatbot script providers</span></span>
<span id="cb7-86"><a href="#cb7-86" aria-hidden="true" tabindex="-1"></a>            scripts <span class="op">=</span> <span class="cf">await</span> page.query_selector_all(<span class="st">"script"</span>)</span>
<span id="cb7-87"><a href="#cb7-87" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> script <span class="kw">in</span> scripts:</span>
<span id="cb7-88"><a href="#cb7-88" aria-hidden="true" tabindex="-1"></a>                script_src <span class="op">=</span> <span class="cf">await</span> script.get_attribute(<span class="st">"src"</span>)</span>
<span id="cb7-89"><a href="#cb7-89" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> script_src:</span>
<span id="cb7-90"><a href="#cb7-90" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">for</span> provider, name <span class="kw">in</span> chatbot_script_providers.items():</span>
<span id="cb7-91"><a href="#cb7-91" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> provider <span class="kw">in</span> script_src:</span>
<span id="cb7-92"><a href="#cb7-92" aria-hidden="true" tabindex="-1"></a>                            chatbot_found <span class="op">=</span> <span class="va">True</span></span>
<span id="cb7-93"><a href="#cb7-93" aria-hidden="true" tabindex="-1"></a>                            chatbot_provider <span class="op">=</span> name</span>
<span id="cb7-94"><a href="#cb7-94" aria-hidden="true" tabindex="-1"></a>                            <span class="cf">break</span></span>
<span id="cb7-95"><a href="#cb7-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-96"><a href="#cb7-96" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Extract company description</span></span>
<span id="cb7-97"><a href="#cb7-97" aria-hidden="true" tabindex="-1"></a>            description_element <span class="op">=</span> <span class="cf">await</span> page.query_selector(<span class="st">'meta[name="description"]'</span>)</span>
<span id="cb7-98"><a href="#cb7-98" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> description_element:</span>
<span id="cb7-99"><a href="#cb7-99" aria-hidden="true" tabindex="-1"></a>                company_description <span class="op">=</span> <span class="cf">await</span> description_element.get_attribute(<span class="st">"content"</span>)</span>
<span id="cb7-100"><a href="#cb7-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-101"><a href="#cb7-101" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Extract emails</span></span>
<span id="cb7-102"><a href="#cb7-102" aria-hidden="true" tabindex="-1"></a>            page_content <span class="op">=</span> <span class="cf">await</span> page.content()</span>
<span id="cb7-103"><a href="#cb7-103" aria-hidden="true" tabindex="-1"></a>            raw_emails <span class="op">=</span> re.findall(<span class="vs">r"[a-zA-Z0-9_.+-]+@[a-zA-Z0-9-]+\.[a-zA-Z0-9-.]+"</span>, page_content)</span>
<span id="cb7-104"><a href="#cb7-104" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> email <span class="kw">in</span> raw_emails:</span>
<span id="cb7-105"><a href="#cb7-105" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="bu">any</span>(email.endswith(domain) <span class="cf">for</span> domain <span class="kw">in</span> valid_email_domains):</span>
<span id="cb7-106"><a href="#cb7-106" aria-hidden="true" tabindex="-1"></a>                    emails.add(email)</span>
<span id="cb7-107"><a href="#cb7-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-108"><a href="#cb7-108" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Extract phone number</span></span>
<span id="cb7-109"><a href="#cb7-109" aria-hidden="true" tabindex="-1"></a>            phone_match <span class="op">=</span> re.search(<span class="vs">r"\(?\d</span><span class="sc">{3}</span><span class="vs">\)?[-.\s]?\d</span><span class="sc">{3}</span><span class="vs">[-.\s]?\d</span><span class="sc">{4}</span><span class="vs">"</span>, page_content)</span>
<span id="cb7-110"><a href="#cb7-110" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> phone_match:</span>
<span id="cb7-111"><a href="#cb7-111" aria-hidden="true" tabindex="-1"></a>                phone <span class="op">=</span> phone_match.group(<span class="dv">0</span>)</span>
<span id="cb7-112"><a href="#cb7-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-113"><a href="#cb7-113" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Extract social media links</span></span>
<span id="cb7-114"><a href="#cb7-114" aria-hidden="true" tabindex="-1"></a>            links <span class="op">=</span> <span class="cf">await</span> page.query_selector_all(<span class="st">"a"</span>)</span>
<span id="cb7-115"><a href="#cb7-115" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> link <span class="kw">in</span> links:</span>
<span id="cb7-116"><a href="#cb7-116" aria-hidden="true" tabindex="-1"></a>                href <span class="op">=</span> <span class="cf">await</span> link.get_attribute(<span class="st">"href"</span>)</span>
<span id="cb7-117"><a href="#cb7-117" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="kw">not</span> href:</span>
<span id="cb7-118"><a href="#cb7-118" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">continue</span></span>
<span id="cb7-119"><a href="#cb7-119" aria-hidden="true" tabindex="-1"></a>                href_lower <span class="op">=</span> href.lower()</span>
<span id="cb7-120"><a href="#cb7-120" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="st">"instagram.com"</span> <span class="kw">in</span> href_lower:</span>
<span id="cb7-121"><a href="#cb7-121" aria-hidden="true" tabindex="-1"></a>                    instagram <span class="op">=</span> href</span>
<span id="cb7-122"><a href="#cb7-122" aria-hidden="true" tabindex="-1"></a>                <span class="cf">elif</span> <span class="st">"facebook.com"</span> <span class="kw">in</span> href_lower:</span>
<span id="cb7-123"><a href="#cb7-123" aria-hidden="true" tabindex="-1"></a>                    facebook <span class="op">=</span> href</span>
<span id="cb7-124"><a href="#cb7-124" aria-hidden="true" tabindex="-1"></a>                <span class="cf">elif</span> <span class="st">"linkedin.com"</span> <span class="kw">in</span> href_lower:</span>
<span id="cb7-125"><a href="#cb7-125" aria-hidden="true" tabindex="-1"></a>                    linkedin <span class="op">=</span> href</span>
<span id="cb7-126"><a href="#cb7-126" aria-hidden="true" tabindex="-1"></a>                <span class="cf">elif</span> <span class="st">"twitter.com"</span> <span class="kw">in</span> href_lower:</span>
<span id="cb7-127"><a href="#cb7-127" aria-hidden="true" tabindex="-1"></a>                    twitter <span class="op">=</span> href</span>
<span id="cb7-128"><a href="#cb7-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-129"><a href="#cb7-129" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Check for a contact page</span></span>
<span id="cb7-130"><a href="#cb7-130" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> link <span class="kw">in</span> links:</span>
<span id="cb7-131"><a href="#cb7-131" aria-hidden="true" tabindex="-1"></a>                href <span class="op">=</span> <span class="cf">await</span> link.get_attribute(<span class="st">"href"</span>)</span>
<span id="cb7-132"><a href="#cb7-132" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> href <span class="kw">and</span> <span class="bu">any</span>(keyword <span class="kw">in</span> href.lower() <span class="cf">for</span> keyword <span class="kw">in</span> contact_keywords):</span>
<span id="cb7-133"><a href="#cb7-133" aria-hidden="true" tabindex="-1"></a>                    contact_page_found <span class="op">=</span> <span class="st">"Yes"</span></span>
<span id="cb7-134"><a href="#cb7-134" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">break</span></span>
<span id="cb7-135"><a href="#cb7-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-136"><a href="#cb7-136" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"✅ </span><span class="sc">{</span>url<span class="sc">}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'HAS a chatbot'</span> <span class="cf">if</span> chatbot_found <span class="cf">else</span> <span class="st">'does NOT have a chatbot'</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb7-137"><a href="#cb7-137" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> {</span>
<span id="cb7-138"><a href="#cb7-138" aria-hidden="true" tabindex="-1"></a>                <span class="st">"Website"</span>: url,</span>
<span id="cb7-139"><a href="#cb7-139" aria-hidden="true" tabindex="-1"></a>                <span class="st">"Has Chatbot"</span>: <span class="st">"Yes"</span> <span class="cf">if</span> chatbot_found <span class="cf">else</span> <span class="st">"No"</span>,</span>
<span id="cb7-140"><a href="#cb7-140" aria-hidden="true" tabindex="-1"></a>                <span class="st">"Chatbot Provider"</span>: chatbot_provider,</span>
<span id="cb7-141"><a href="#cb7-141" aria-hidden="true" tabindex="-1"></a>                <span class="st">"Company Description"</span>: company_description,</span>
<span id="cb7-142"><a href="#cb7-142" aria-hidden="true" tabindex="-1"></a>                <span class="st">"Contact Page Found"</span>: contact_page_found,</span>
<span id="cb7-143"><a href="#cb7-143" aria-hidden="true" tabindex="-1"></a>                <span class="st">"Emails"</span>: <span class="bu">list</span>(emails),</span>
<span id="cb7-144"><a href="#cb7-144" aria-hidden="true" tabindex="-1"></a>                <span class="st">"Phone"</span>: phone,</span>
<span id="cb7-145"><a href="#cb7-145" aria-hidden="true" tabindex="-1"></a>                <span class="st">"Instagram"</span>: instagram,</span>
<span id="cb7-146"><a href="#cb7-146" aria-hidden="true" tabindex="-1"></a>                <span class="st">"LinkedIn"</span>: linkedin,</span>
<span id="cb7-147"><a href="#cb7-147" aria-hidden="true" tabindex="-1"></a>                <span class="st">"Facebook"</span>: facebook,</span>
<span id="cb7-148"><a href="#cb7-148" aria-hidden="true" tabindex="-1"></a>                <span class="st">"Twitter"</span>: twitter</span>
<span id="cb7-149"><a href="#cb7-149" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb7-150"><a href="#cb7-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-151"><a href="#cb7-151" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb7-152"><a href="#cb7-152" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"❌ Error with </span><span class="sc">{</span>url<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb7-153"><a href="#cb7-153" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> {<span class="st">"Website"</span>: url, <span class="st">"Has Chatbot"</span>: <span class="st">"Error"</span>}</span>
<span id="cb7-154"><a href="#cb7-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-155"><a href="#cb7-155" aria-hidden="true" tabindex="-1"></a>        <span class="cf">finally</span>:</span>
<span id="cb7-156"><a href="#cb7-156" aria-hidden="true" tabindex="-1"></a>            <span class="cf">await</span> browser.close()</span>
<span id="cb7-157"><a href="#cb7-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-158"><a href="#cb7-158" aria-hidden="true" tabindex="-1"></a><span class="co"># Batch processing for chatbot detection</span></span>
<span id="cb7-159"><a href="#cb7-159" aria-hidden="true" tabindex="-1"></a>semaphore <span class="op">=</span> asyncio.Semaphore(<span class="dv">12</span>)</span>
<span id="cb7-160"><a href="#cb7-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-161"><a href="#cb7-161" aria-hidden="true" tabindex="-1"></a><span class="cf">async</span> <span class="kw">def</span> check_single_website_limited(url):</span>
<span id="cb7-162"><a href="#cb7-162" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="cf">with</span> semaphore:</span>
<span id="cb7-163"><a href="#cb7-163" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="cf">await</span> check_single_website(url)</span>
<span id="cb7-164"><a href="#cb7-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-165"><a href="#cb7-165" aria-hidden="true" tabindex="-1"></a><span class="cf">async</span> <span class="kw">def</span> run_chatbot_detection_in_batches(urls, batch_size<span class="op">=</span><span class="dv">12</span>):</span>
<span id="cb7-166"><a href="#cb7-166" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> []</span>
<span id="cb7-167"><a href="#cb7-167" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">0</span>, <span class="bu">len</span>(urls), batch_size):</span>
<span id="cb7-168"><a href="#cb7-168" aria-hidden="true" tabindex="-1"></a>        batch <span class="op">=</span> urls[i:i <span class="op">+</span> batch_size]</span>
<span id="cb7-169"><a href="#cb7-169" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"🚀 Processing batch </span><span class="sc">{</span>i <span class="op">//</span> batch_size <span class="op">+</span> <span class="dv">1</span><span class="sc">}</span><span class="ss"> of </span><span class="sc">{</span> (<span class="bu">len</span>(urls) <span class="op">+</span> batch_size <span class="op">-</span> <span class="dv">1</span>) <span class="op">//</span> batch_size <span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span><span class="bu">len</span>(batch)<span class="sc">}</span><span class="ss"> URLs)"</span>)</span>
<span id="cb7-170"><a href="#cb7-170" aria-hidden="true" tabindex="-1"></a>        tasks <span class="op">=</span> [check_single_website_limited(url) <span class="cf">for</span> url <span class="kw">in</span> batch]</span>
<span id="cb7-171"><a href="#cb7-171" aria-hidden="true" tabindex="-1"></a>        batch_results <span class="op">=</span> <span class="cf">await</span> asyncio.gather(<span class="op">*</span>tasks)</span>
<span id="cb7-172"><a href="#cb7-172" aria-hidden="true" tabindex="-1"></a>        results.extend(batch_results)</span>
<span id="cb7-173"><a href="#cb7-173" aria-hidden="true" tabindex="-1"></a>        <span class="cf">await</span> asyncio.sleep(random.uniform(<span class="dv">0</span>, <span class="fl">0.5</span>))</span>
<span id="cb7-174"><a href="#cb7-174" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> results</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here I am creating the main pipeline that orchestrates the entire process. It first scrapes the data from clutch.co, then checks each website for chatbot/contact info, merges the two DataFrames on the cleaned domain.</p>
<div id="d1692a9b" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="co"># PART D: MAIN PIPELINE</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="cf">async</span> <span class="kw">def</span> run_clutch_and_chatbot_pipeline(base_url, max_pages):</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="co">    1. Scrapes data from clutch.</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="co">    2. Checks each scraped website for chatbot/contact info.</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="co">    3. Merges both DataFrames on the cleaned domain.</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="co">    4. Adds traffic data using the original website URLs.</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a><span class="co">    5. Returns the final merged DataFrame.</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 1. Scrape UpCity</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>    df_clutch <span class="op">=</span> <span class="cf">await</span> two_pass_clutch_pipeline(base_url, max_pages)</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Scraped </span><span class="sc">{</span><span class="bu">len</span>(df_clutch)<span class="sc">}</span><span class="ss"> leads from Clutch"</span>)</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Preserve the original website URLs</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>    df_clutch[<span class="st">"original_website"</span>] <span class="op">=</span> df_clutch[<span class="st">"Website"</span>]</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 2. Check each website for chatbot info (sequentially for clarity)</span></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>    chatbot_results <span class="op">=</span> <span class="cf">await</span> run_chatbot_detection_in_batches(df_clutch[<span class="st">"Website"</span>].dropna().tolist(), batch_size<span class="op">=</span><span class="dv">70</span>)</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>    df_chatbot <span class="op">=</span> pd.DataFrame(chatbot_results)</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 3. Merge on cleaned domain</span></span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>    df_clutch[<span class="st">"cleaned_website"</span>] <span class="op">=</span> df_clutch[<span class="st">"Website"</span>].<span class="bu">apply</span>(clean_domain)</span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>    df_chatbot[<span class="st">"cleaned_website"</span>] <span class="op">=</span> df_chatbot[<span class="st">"Website"</span>].<span class="bu">apply</span>(clean_domain)</span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>    df_merged <span class="op">=</span> pd.merge(</span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>        df_clutch.drop(columns<span class="op">=</span>[<span class="st">"Website"</span>]),</span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>        df_chatbot.drop(columns<span class="op">=</span>[<span class="st">"Website"</span>]),</span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>        how<span class="op">=</span><span class="st">"left"</span>,</span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>        on<span class="op">=</span><span class="st">"cleaned_website"</span></span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a>    df_merged <span class="op">=</span> clean_final_clutch_df(df_merged)</span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a>    df_final <span class="op">=</span> df_merged.drop_duplicates(subset<span class="op">=</span><span class="st">"Business_Name"</span>)</span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df_final</span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-43"><a href="#cb8-43" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> clutch_pipeline(base_url, max_pages):</span>
<span id="cb8-44"><a href="#cb8-44" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb8-45"><a href="#cb8-45" aria-hidden="true" tabindex="-1"></a><span class="co">    Synchronous wrapper for the asynchronous pipeline.</span></span>
<span id="cb8-46"><a href="#cb8-46" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb8-47"><a href="#cb8-47" aria-hidden="true" tabindex="-1"></a>    start_time <span class="op">=</span> time.time()</span>
<span id="cb8-48"><a href="#cb8-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-49"><a href="#cb8-49" aria-hidden="true" tabindex="-1"></a>    df_final <span class="op">=</span> asyncio.run(run_clutch_and_chatbot_pipeline(base_url, max_pages))</span>
<span id="cb8-50"><a href="#cb8-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-51"><a href="#cb8-51" aria-hidden="true" tabindex="-1"></a>    end_time <span class="op">=</span> time.time()</span>
<span id="cb8-52"><a href="#cb8-52" aria-hidden="true" tabindex="-1"></a>    elapsed_seconds <span class="op">=</span> end_time <span class="op">-</span> start_time</span>
<span id="cb8-53"><a href="#cb8-53" aria-hidden="true" tabindex="-1"></a>    elapsed_mins <span class="op">=</span> elapsed_seconds<span class="op">/</span><span class="dv">60</span></span>
<span id="cb8-54"><a href="#cb8-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-55"><a href="#cb8-55" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Pipeline completed in </span><span class="sc">{</span>elapsed_seconds<span class="sc">:.2f}</span><span class="ss"> seconds (</span><span class="sc">{</span>elapsed_mins<span class="sc">:.2f}</span><span class="ss"> minutes)."</span>)</span>
<span id="cb8-56"><a href="#cb8-56" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df_final</span>
<span id="cb8-57"><a href="#cb8-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-58"><a href="#cb8-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-59"><a href="#cb8-59" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------</span></span>
<span id="cb8-60"><a href="#cb8-60" aria-hidden="true" tabindex="-1"></a><span class="co"># USAGE EXAMPLE</span></span>
<span id="cb8-61"><a href="#cb8-61" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------</span></span>
<span id="cb8-62"><a href="#cb8-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-63"><a href="#cb8-63" aria-hidden="true" tabindex="-1"></a><span class="co">#cant run knit with this line </span></span>
<span id="cb8-64"><a href="#cb8-64" aria-hidden="true" tabindex="-1"></a><span class="co">#clutch_final_df = clutch_pipeline("https://clutch.co/agencies/digital-marketing", 240)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>After getting the data from the pipeline I integrated semrush data into the final DataFrame. I used the bulk webmetrics checker on semrush to get the traffic data for each website. I then merged this data with the main DataFrame using the cleaned domain as the key. The final DataFrame contains all the relevant information, including lead scores, chatbot presence, and website traffic metrics, bouce rate, and visit duration.</p>
<p>I experimented with many free trial APIs and scraping methods to get the traffic data but I found that using semrush was the most reliable and accurate method. SEO review tools also has a free API that I used to get the traffic data but it was not as reliable as semrush.</p>
<p>So below I created a function to ease the process of cleaning and merging data from semrush back to the orignal DataFrame.</p>
<div id="39c9c7c6" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co">#------------------------------------------</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="co"># MERGE SEMRUSH API DATA FOR WEBSITE STATS</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="co">#------------------------------------------</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="co">#formatting data to be exported to semrush</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="co">#print("\n".join(clutch_final_df["cleaned_website"].dropna().astype(str).tolist()))</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="co">#use the printed list and go to https://www.semrush.com/analytics/traffic/ for the bulk webmetrics checker, turn the data into</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a><span class="co">#csv files concat them and merge it to clutch_final_df</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> merge_semrush_data(df, semrush_csv_files):</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a><span class="co">    Loads multiple SEMrush CSV files, cleans the data, and merges with the provided dataframe.</span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters:</span></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a><span class="co">        df (pd.DataFrame): Your main dataset (clutch_final_df).</span></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a><span class="co">        semrush_csv_files (list): List of file paths for SEMrush CSV files.</span></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a><span class="co">        pd.DataFrame: Updated dataframe with SEMrush data merged.</span></span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Load and concatenate SEMrush CSV files</span></span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>    web_data <span class="op">=</span> pd.concat([pd.read_csv(<span class="ss">f"C:/Users/jason/Downloads/</span><span class="sc">{</span><span class="bu">file</span><span class="sc">}</span><span class="ss">.csv"</span>) <span class="cf">for</span> <span class="bu">file</span> <span class="kw">in</span> semrush_csv_files], ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Rename columns</span></span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>    web_data.rename(columns<span class="op">=</span>{<span class="st">"Target"</span>: <span class="st">"cleaned_website"</span>}, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Drop unnecessary columns</span></span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>    columns_to_drop <span class="op">=</span> [<span class="st">"Target type"</span>, <span class="st">"Purchase Conversion"</span>]</span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a>    web_data.drop(columns<span class="op">=</span>columns_to_drop, axis<span class="op">=</span><span class="dv">1</span>, errors<span class="op">=</span><span class="st">'ignore'</span>, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Merge datasets</span></span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a>    merged_df <span class="op">=</span> df.merge(web_data, on<span class="op">=</span><span class="st">"cleaned_website"</span>, how<span class="op">=</span><span class="st">"left"</span>)</span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a>    merged_df[<span class="st">"Bounce Rate"</span>] <span class="op">=</span> pd.to_numeric(</span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a>        merged_df[<span class="st">"Bounce Rate"</span>].<span class="bu">str</span>.replace(<span class="st">"%"</span>, <span class="st">""</span>, regex<span class="op">=</span><span class="va">True</span>),</span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a>        errors<span class="op">=</span><span class="st">'coerce'</span></span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a>    merged_df[<span class="st">"Avg. Visit Duration"</span>] <span class="op">=</span> merged_df[<span class="st">"Avg. Visit Duration"</span>].astype(<span class="bu">str</span>).<span class="bu">str</span>.strip()</span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-42"><a href="#cb9-42" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Drop invalid duration values before conversion</span></span>
<span id="cb9-43"><a href="#cb9-43" aria-hidden="true" tabindex="-1"></a>    merged_df <span class="op">=</span> merged_df[merged_df[<span class="st">"Avg. Visit Duration"</span>].<span class="bu">str</span>.match(<span class="vs">r'^\d{1,2}:\d</span><span class="sc">{2}</span><span class="vs">$'</span>, na<span class="op">=</span><span class="va">False</span>)]</span>
<span id="cb9-44"><a href="#cb9-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-45"><a href="#cb9-45" aria-hidden="true" tabindex="-1"></a>    merged_df[<span class="st">"Visit Duration"</span>] <span class="op">=</span> pd.to_timedelta(<span class="st">"00:"</span> <span class="op">+</span> merged_df[<span class="st">"Avg. Visit Duration"</span>]).dt.total_seconds()</span>
<span id="cb9-46"><a href="#cb9-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-47"><a href="#cb9-47" aria-hidden="true" tabindex="-1"></a>    merged_df.drop([<span class="st">"Avg. Visit Duration"</span>], axis <span class="op">=</span> <span class="dv">1</span>, inplace <span class="op">=</span> <span class="va">True</span>)</span>
<span id="cb9-48"><a href="#cb9-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-49"><a href="#cb9-49" aria-hidden="true" tabindex="-1"></a>    merged_df[[<span class="st">"Visits"</span>, <span class="st">"Unique Visitors"</span>]] <span class="op">=</span> merged_df[[<span class="st">"Visits"</span>, <span class="st">"Unique Visitors"</span>]].fillna(<span class="dv">0</span>)</span>
<span id="cb9-50"><a href="#cb9-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-51"><a href="#cb9-51" aria-hidden="true" tabindex="-1"></a>    merged_df.rename(columns <span class="op">=</span> {<span class="st">"Average Visit Duration (seconds)"</span>:<span class="st">"Visit Duration"</span>,<span class="st">"Pages / Visit"</span> : <span class="st">"Pages_Per_Visit"</span>}, inplace <span class="op">=</span> <span class="va">True</span>)</span>
<span id="cb9-52"><a href="#cb9-52" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-53"><a href="#cb9-53" aria-hidden="true" tabindex="-1"></a>    merged_df.drop([<span class="st">"Company Description"</span>], axis <span class="op">=</span> <span class="dv">1</span>, inplace <span class="op">=</span> <span class="va">True</span>)</span>
<span id="cb9-54"><a href="#cb9-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-55"><a href="#cb9-55" aria-hidden="true" tabindex="-1"></a>    filtered_df <span class="op">=</span> merged_df[merged_df[<span class="st">"Bounce Rate"</span>].notnull() <span class="op">&amp;</span> merged_df[<span class="st">"Visit Duration"</span>].notnull() <span class="op">&amp;</span> merged_df[<span class="st">"Pages_Per_Visit"</span>].notnull()]</span>
<span id="cb9-56"><a href="#cb9-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-57"><a href="#cb9-57" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-58"><a href="#cb9-58" aria-hidden="true" tabindex="-1"></a>    filtered_df <span class="op">=</span> filtered_df[<span class="op">~</span>((filtered_df[<span class="st">"Bounce Rate"</span>] <span class="op">==</span> <span class="dv">100</span>) <span class="op">&amp;</span> (filtered_df[<span class="st">"Visit Duration"</span>] <span class="op">==</span> <span class="dv">0</span>))]</span>
<span id="cb9-59"><a href="#cb9-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-60"><a href="#cb9-60" aria-hidden="true" tabindex="-1"></a>    filtered_df <span class="op">=</span> add_lead_score(filtered_df)</span>
<span id="cb9-61"><a href="#cb9-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-62"><a href="#cb9-62" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> filtered_df</span>
<span id="cb9-63"><a href="#cb9-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-64"><a href="#cb9-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-65"><a href="#cb9-65" aria-hidden="true" tabindex="-1"></a><span class="co"># Example usage:</span></span>
<span id="cb9-66"><a href="#cb9-66" aria-hidden="true" tabindex="-1"></a>semrush_files <span class="op">=</span> [</span>
<span id="cb9-67"><a href="#cb9-67" aria-hidden="true" tabindex="-1"></a>    <span class="st">"A"</span>,</span>
<span id="cb9-68"><a href="#cb9-68" aria-hidden="true" tabindex="-1"></a>    <span class="st">"B"</span>,</span>
<span id="cb9-69"><a href="#cb9-69" aria-hidden="true" tabindex="-1"></a>    <span class="st">"C"</span>,</span>
<span id="cb9-70"><a href="#cb9-70" aria-hidden="true" tabindex="-1"></a>    <span class="st">"D"</span>,</span>
<span id="cb9-71"><a href="#cb9-71" aria-hidden="true" tabindex="-1"></a>    <span class="st">"E"</span>,</span>
<span id="cb9-72"><a href="#cb9-72" aria-hidden="true" tabindex="-1"></a>    <span class="st">"F"</span>,</span>
<span id="cb9-73"><a href="#cb9-73" aria-hidden="true" tabindex="-1"></a>    <span class="st">"G"</span>,</span>
<span id="cb9-74"><a href="#cb9-74" aria-hidden="true" tabindex="-1"></a>    <span class="st">"H"</span>,</span>
<span id="cb9-75"><a href="#cb9-75" aria-hidden="true" tabindex="-1"></a>    <span class="st">"I"</span>,</span>
<span id="cb9-76"><a href="#cb9-76" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb9-77"><a href="#cb9-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-78"><a href="#cb9-78" aria-hidden="true" tabindex="-1"></a><span class="co">#clutch_final_df = merge_semrush_data(clutch_final_df, semrush_files)</span></span>
<span id="cb9-79"><a href="#cb9-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-80"><a href="#cb9-80" aria-hidden="true" tabindex="-1"></a><span class="co">#clutch_final_df.info()</span></span>
<span id="cb9-81"><a href="#cb9-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-82"><a href="#cb9-82" aria-hidden="true" tabindex="-1"></a><span class="co">#clutch_final_df["lead_score"].mean()</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Lastly I created some functions to export my leads to a google cloud table and save them as csv files. I used the google cloud bigquery library to load the data into a new table and append new data to an existing table. I also created a function to save the DataFrame as a CSV file for local storage.</p>
<div id="28708372" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co">#===============================</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="co"># SAVING / DEPLOYMENT EXAMPLES</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="co">#===============================</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="co">#-------------------------------</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="co"># SAVING TO GOOGLE CLOUD TABLE</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="co">#-------------------------------</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> google.cloud <span class="im">import</span> bigquery</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a><span class="co">#-------------------------------------------------------------------------</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a><span class="co">#load inital data into new big query table</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> load_data_to_bigquery(df, project_id, dataset_id, table_id):</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>    client <span class="op">=</span> bigquery.Client(project<span class="op">=</span>project_id)</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>    table_ref <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>project_id<span class="sc">}</span><span class="ss">.</span><span class="sc">{</span>dataset_id<span class="sc">}</span><span class="ss">.</span><span class="sc">{</span>table_id<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>    job <span class="op">=</span> client.load_table_from_dataframe(df, table_ref)</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>    job.result()  <span class="co"># Wait for the job to complete.</span></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Loaded </span><span class="sc">{</span>job<span class="sc">.</span>output_rows<span class="sc">}</span><span class="ss"> rows into </span><span class="sc">{</span>table_ref<span class="sc">}</span><span class="ss">."</span>)</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a><span class="co">#---------------------------------------------------------------------------</span></span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a><span class="co">#append data to big query</span></span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> append_data_to_bigquery(df, project_id, dataset_id, table_id):</span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>    client <span class="op">=</span> bigquery.Client(project<span class="op">=</span>project_id)</span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>    table_ref <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>project_id<span class="sc">}</span><span class="ss">.</span><span class="sc">{</span>dataset_id<span class="sc">}</span><span class="ss">.</span><span class="sc">{</span>table_id<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>    job_config <span class="op">=</span> bigquery.LoadJobConfig(</span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>        write_disposition<span class="op">=</span>bigquery.WriteDisposition.WRITE_APPEND  <span class="co"># Append data</span></span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>    job <span class="op">=</span> client.load_table_from_dataframe(df, table_ref, job_config<span class="op">=</span>job_config)</span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>    job.result()  <span class="co"># Wait for the job to complete.</span></span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Appended </span><span class="sc">{</span>job<span class="sc">.</span>output_rows<span class="sc">}</span><span class="ss"> rows into </span><span class="sc">{</span>table_ref<span class="sc">}</span><span class="ss">."</span>)</span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a><span class="co">#---------------------------------------------------------------------------   </span></span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a><span class="co">#load_data_to_bigquery(clutch_final_df, 'leadgenautomationstorage', 'automated_lead_generation_database', 'clutch_leads')</span></span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a><span class="co">#append_data_to_bigquery(clutch_final_df, 'leadgenautomationstorage', 'automated_lead_generation_database', 'clutch_leads')</span></span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a><span class="co">#-----------------</span></span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true" tabindex="-1"></a><span class="co"># SAVING TO CSV</span></span>
<span id="cb10-43"><a href="#cb10-43" aria-hidden="true" tabindex="-1"></a><span class="co">#-----------------</span></span>
<span id="cb10-44"><a href="#cb10-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-45"><a href="#cb10-45" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_csv(df, name):</span>
<span id="cb10-46"><a href="#cb10-46" aria-hidden="true" tabindex="-1"></a>    df.to_csv(<span class="ss">f"C:/Users/jason/Downloads/</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">.csv"</span>, index <span class="op">=</span> <span class="va">False</span>)</span>
<span id="cb10-47"><a href="#cb10-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-48"><a href="#cb10-48" aria-hidden="true" tabindex="-1"></a><span class="co">#create_csv(clutch_final_df, "clutch_dtmarketing_pages20-100-optimized")</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Findings:</p>
<p>From my data I found that about 25% of businesses dont already have a chatbot, showing a growing demand a reason they should want to meet industry standards. I also found that different industries produce better leads than others. Businesses with more traffic are better lead opportunities.</p>
<p>I scraped probably about 100,000 business and scrapped alot of it because I kept finding ways to improve my methods and needed to start over. The process I ended up with (the pipeline above) is what I ended with, which instead of returning all of the businesses scraped from clutch only returns the ones with out a chatbot. I then filtered the data further after passing the links through semrush, some of the semresh results came back as n/a for traffic, bounce and time on site meaning that business might not even have use for a chatbot so I filtered those out as well. Instead of collecting a massive list of leads I ended with 1000 semi qualified leads in my bigquery and ill attach here as a csv file.</p>
<p>well actually BigQuery wont let me export my data as a csv so ill attach a eariler iteration of my data:</p>
<div id="d42acfb4" class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> pd.read_csv(<span class="vs">r"C:\Users\jason\Downloads\clutch_dtmarketing_pages1-20-optimized.csv"</span>)</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>data.head()</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="co">#this version is from using the seo review tools api to get traffic data instead of sem rush here I used engineered features to score the leads "est_revenue" and "web_conversion_rate" which logically made sense to me but ultimately was not the best solution which is why I tried with semrush. But either way this is still the general idea of the pipeline I ended up with.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="9">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Business_Name</th>
<th data-quarto-table-cell-role="th">Industry</th>
<th data-quarto-table-cell-role="th">original_website</th>
<th data-quarto-table-cell-role="th">Has Chatbot</th>
<th data-quarto-table-cell-role="th">Chatbot Provider</th>
<th data-quarto-table-cell-role="th">Domain Authority</th>
<th data-quarto-table-cell-role="th">web_conversion_rate</th>
<th data-quarto-table-cell-role="th">est_revenue</th>
<th data-quarto-table-cell-role="th">organic</th>
<th data-quarto-table-cell-role="th">paid</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">Emails</th>
<th data-quarto-table-cell-role="th">Phone</th>
<th data-quarto-table-cell-role="th">Instagram</th>
<th data-quarto-table-cell-role="th">LinkedIn</th>
<th data-quarto-table-cell-role="th">Facebook</th>
<th data-quarto-table-cell-role="th">Twitter</th>
<th data-quarto-table-cell-role="th">Company Description</th>
<th data-quarto-table-cell-role="th">Location</th>
<th data-quarto-table-cell-role="th">cleaned_website</th>
<th data-quarto-table-cell-role="th">lead_score</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>Silverback Strategies</td>
<td>Pay Per Click</td>
<td>http://silverbackstrategies.com/</td>
<td>Yes</td>
<td>NaN</td>
<td>41</td>
<td>0.006247</td>
<td>125000.0</td>
<td>4002.0</td>
<td>0.0</td>
<td>...</td>
<td>['info@silverbackstrategies.com']</td>
<td>1637439359</td>
<td>https://www.instagram.com/silverbackstrategies/</td>
<td>https://www.linkedin.com/company/silverback-st...</td>
<td>https://www.facebook.com/silverbackstrategies</td>
<td>https://twitter.com/SilverbackStrat</td>
<td>Silverback Strategies is a premier digital per...</td>
<td>Arlington, VA</td>
<td>silverbackstrategies.com</td>
<td>60.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>Taktical Digital</td>
<td>Social Media Marketing</td>
<td>https://taktical.co/clutch/</td>
<td>Yes</td>
<td>NaN</td>
<td>45</td>
<td>0.008381</td>
<td>0.0</td>
<td>5727.0</td>
<td>0.0</td>
<td>...</td>
<td>[]</td>
<td>1740342300</td>
<td>https://www.instagram.com/takticaldigital/</td>
<td>https://www.linkedin.com/company/taktical/</td>
<td>https://www.facebook.com/takticaldigital/</td>
<td>https://twitter.com/takticaldigital</td>
<td>Taktical Digital is a digital marketing agency...</td>
<td>New York, NY</td>
<td>taktical.co</td>
<td>52.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>Straight North</td>
<td>Search Engine Optimization</td>
<td>https://www.straightnorth.com/</td>
<td>No</td>
<td>NaN</td>
<td>0</td>
<td>0.006425</td>
<td>128000.0</td>
<td>19922.0</td>
<td>103.0</td>
<td>...</td>
<td>[]</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>Chicago, IL</td>
<td>www.straightnorth.com</td>
<td>80.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>KlientBoost</td>
<td>Pay Per Click</td>
<td>https://klientboost.com/results/</td>
<td>No</td>
<td>NaN</td>
<td>53</td>
<td>0.005765</td>
<td>391000.0</td>
<td>67822.0</td>
<td>65.0</td>
<td>...</td>
<td>['friends@klientboost.com']</td>
<td>1740342300</td>
<td>https://www.instagram.com/klientboost/</td>
<td>https://www.linkedin.com/company/klientboost</td>
<td>https://www.facebook.com/business/partner-dire...</td>
<td>NaN</td>
<td>We average 63% increase ROI for over 200 clien...</td>
<td>Costa Mesa, CA</td>
<td>klientboost.com</td>
<td>97.5</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>Socium Media</td>
<td>Pay Per Click</td>
<td>https://www.sociummedia.com/clutch-socium-media/</td>
<td>Yes</td>
<td>NaN</td>
<td>0</td>
<td>0.007026</td>
<td>120000.0</td>
<td>3416.0</td>
<td>18.0</td>
<td>...</td>
<td>[]</td>
<td>3508623293</td>
<td>https://www.instagram.com/sociummedia/</td>
<td>https://www.linkedin.com/company/sociummedia/</td>
<td>NaN</td>
<td>NaN</td>
<td>Socium Media is an award-winning performance m...</td>
<td>New York, NY</td>
<td>www.sociummedia.com</td>
<td>52.0</td>
</tr>
</tbody>
</table>

<p>5 rows × 23 columns</p>
</div>
</div>
</div>
<p>Discussion: My goal for this project was to get one paying client before the presentation which I had failed to do. Ill continue to work on this and work out the flaws. I realized so much is wrong with this project and in order to get real high quality leads that chatbot developeres will pay for theres alot more that needs to be done.</p>
<p>The first mistake I made is all of the businesses I scrapped potential clients and leads are all from clutch.co a B2B directory. The issue is B2B companies often do alot of thier business throug networking and high ticket slaes so they arent highly interest to invest inchatbot automation on thier websites. I learned this after reaching out to digital marketing agencies where I reapeatly got not intersested or no response.</p>
<p>However when I reached out to chatbot compaines I got much better responses and interst this showed me there is a demand for this I was just fishing in the wrong pond. The businesses that need chatbots are high traffic websites in the B2C sector. This made me think I should target shopify stores, e-commerce websites, and other high traffic B2C websites.</p>
<p>I discovered a dataset owned by a website called builtwith that has every shopify store in existance and plenty of data to go with it. From here Ill take all 9 million stores and automate email reach out using gmass and track the open rates click rates and responses to pre-qualify the leads interest before selling them this will dramaitcally increase the quality and value of the leads. With builtwiths dataset I will also access linked in profiles where I plan on integrating the services of a company called phantom buster to scrape the linked in profiles of the business owners and automate the outreach process. From here ill have a multi channel out reach to qualify leads and a massive list of busiesses to reach out to. After getting results of the email campagin I will build machine learning models to predict whether a business will be a warm lead or cold lead based on the data I have collected and do fouced out reach to buisinesses that are most likely to convert. I also plan on using the data I have collected to build a lead scoring model that will help me prioritize leads based on their potential value. This will help me focus my efforts on the most promising leads and increase my chances of closing deals.</p>
<p>It would also be cool to make visualizations comparing the success of shopify stores with and without chatbots to include in the emails to cause FOMO and increase the chances of a business owner wanting to implement a chatbot.</p>
<p>I had a fun time doing this project, every day a new challenge presented itself that made me think it couldnt work but I kept trying and eventually got to the idea I presented in the discussion.</p>
<p>I learned alot about what makes leads valueable. My project misses a critacl part which is eamil out reach and campagin results but im working on doing that now.</p>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>